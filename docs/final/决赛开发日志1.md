# å†³èµ›å¼€å‘æ—¥å¿— by wdlin

æˆ‘ä»¬è®¤ä¸ºåœ¨å­¦ä¹ åˆ«äººå†…æ ¸æ—¶æœ‰ä¸€ä¸ªè¿™æ ·ç±»ä¼¼çš„æ–‡æ¡£ï¼Œæ¥è®°å½•å„ç§é‡åˆ°çš„ bug å’Œè®¾è®¡æ—¶çš„è€ƒè™‘æ˜¯å¾ˆå¥½çš„ã€‚è™½ç„¶æˆ‘ä»¬ç»éªŒè¿˜ä¸å……è¶³ï¼Œä½†æ˜¯è¿˜æ˜¯æŠŠè‡ªå·±çš„ä¸€äº›å­¦ä¹ å’Œæ€è€ƒéƒ½è®°å½•ä¸‹æ¥ï¼Œä¸€æ–¹é¢æ˜¯è‡ªå·±è®°å½•å…ˆå‰æ‰€åšçš„äº‹æƒ…ï¼Œè¿˜æœ‰ä¸€æ–¹é¢æ˜¯å¦‚æœä¹‹åæœ‰äººæ— æ„é—´ç¿»åˆ°äº†è¿™ä¸ªå†…æ ¸ï¼Œå¸Œæœ›èƒ½æä¾›ä¸€äº›åŠ›æ‰€èƒ½åŠçš„å¸®åŠ©ã€‚

## ä¸ƒæœˆ

### 2025.7.2

> å‚è€ƒ Linux çš„è®¾è®¡ï¼Œå› ä¸º**ä¿¡å·**çš„è®¾è®¡ç”¨ç»Ÿä¸€çš„ `TaskControlBlock` æ¥å®ç°ä¼šæ›´å¥½ï¼Œè€Œä¸”æˆ‘ä»¬å…ˆå‰å› ä¸ºèµ¶å·¥æ²¡æœ‰å¤ªåœ¨æ„ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ï¼Œæˆ‘ä»¬å†³å®š**é‡æ„**. å°†ç°æœ‰çš„ `ProcessControlBlock` å’Œ `TaskControlBlock` åˆä¸ºåŒä¸€ä¸ªç»“æ„ä½“.

æ‘†çƒ‚ä¸€å¤©åå¼€å§‹è¿›è¡Œé‡æ„ï¼Œå’Œé˜Ÿå‹åˆ†å·¥ï¼Œæˆ‘è´Ÿè´£ä¿®æ”¹çº¿ç¨‹å—çš„éƒ¨åˆ†ï¼Œé˜Ÿå‹è´Ÿè´£æ”¹åœ°å€ç©ºé—´.

`TaskStatus` è¿™ç§ç»“æ„è‚¯å®šæ˜¯å¯ä»¥ç›´æ¥æ”¾åœ¨ `ProcessControlBlock` çš„ï¼Œä¸è¿‡ `exit_code` å°±æœ‰ç‚¹éš¾è¯´ï¼Œå› ä¸ºè¿™å’Œè¿›ç¨‹ç»„è¿˜æœ‰ä¸€ç‚¹å…³ç³»ï¼Œæœ€åè¿˜å’Œä¿¡å·ç›¸å…³.

```rust
#[derive(Copy, Clone, PartialEq, Debug)]
/// The execution status of the current process
pub enum TaskStatus {
    /// ready to run
    Ready,
    /// running
    Running,
    /// blocked
    Blocked,
}
```

æˆ‘ä»¬æ‰“ç®—å‚è€ƒ rCore çš„ ch6 è¿›è¡Œä¿®æ”¹. æ¯”è¾ƒå¹½é»˜çš„æ˜¯ï¼Œ`heap_bottom` å’Œ `program_brk` åœ¨ ch6 ä¸­å°±æ˜¯ä½œä¸º `ProcessControlBlock` çš„æˆå‘˜ï¼Œç°åœ¨æˆ‘ä»¬æƒ³æ”¹å› `TaskControlBlock` ä¸­.

ä¸ç®¡å¯ç»´æŠ¤æ€§è€Œåˆ°å¤„å†™æ¡ä»¶ç¼–è¯‘çœŸçš„å¾ˆæŠ˜ç£¨äºº. å†³å®šå…ˆåš `tid` çš„éƒ¨åˆ†.

`TidHandler` ç›´æ¥å°±è¿ç§»è¿‡æ¥äº†. ç„¶åæŠŠ `TaskContext` çš„é€šç”¨å¯„å­˜å™¨ç»Ÿä¸€äº†ï¼ŒRISCV ä¸‹æœ‰ 12 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œè€Œ LoongArch åªæœ‰ 10 ä¸ªï¼Œå¦‚æœåˆ†å¼€å†™å¾ˆä¸ä¼˜é›…. æˆ–è€…ä¹‹åå•ç‹¬åˆ‡ä¸€ä¸ª `TaskContext` æ”¾åœ¨ `hal` module é‡Œ.

### 2025.7.3

`KernelAddr` ç»“æ„ä½“ç›´æ¥åŒ…è£¹ `usize`ï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†åœ¨ç»Ÿä¸€åœ°å€ç©ºé—´åè¿›è¡Œå†…æ ¸åœ°å€ä¸ç”¨æˆ·åœ°å€çš„åŒºåˆ†. 

åˆ†é…ç”¨æˆ·èµ„æºçš„ `alloc_user_res` æ–¹æ³•ï¼Œé¦–å…ˆåœ¨ `USER_TRAP_CONTEXT_TOP` åˆ†é…ä¸€ä¸ªé¡µçš„ç©ºé—´ç”¨ä½œ Trapï¼Œç„¶ååœ¨ `USER_STACK_TOP` å‘ä½åœ°å€åˆ†é…ä¸€ä¸ª `USER_STACK_SIZE` çš„ç©ºé—´ä½œä¸ºç”¨æˆ·æ ˆï¼Œ`USER_TRAP_CONTEXT_TOP` åœ°å€æ¯” `USER_STACK_TOP` é«˜çº¿ç¨‹æœ€å¤§æ•°é‡çš„é¡µå¤§å°ï¼Œä¹Ÿå°±æ˜¯ Trap çš„å­˜æ”¾åœ°å€æ¯”ç”¨æˆ·æ ˆé«˜. ç„¶åä¼šåœ¨ç”¨æˆ·æ ˆä¸Šé¢„å…ˆæ˜ å°„ä¸€äº›æ®µ.

ç ”ç©¶äº†ä¸€ä¸‹ `sfence.vma`ï¼Œå‘ç°è¿™ä¸ª TLB åˆ·æ–°çš„é—®é¢˜å¥½åƒåœ¨ LA ä¸‹å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼Œè€Œä¸” LA ä¸‹æœ¬èº«å°±éœ€è¦è€ƒè™‘ TLB é‡å¡«çš„é—®é¢˜ï¼Œåé¢åº”è¯¥è¦é‡æ–°è®¾è®¡. 

é€€å‡ºç  `exit_code` çš„é—®é¢˜å®é™…ä¸Šå’Œä¿¡å·çš„æœºåˆ¶æ˜¯ç´§å¯†è¿åœ¨ä¸€èµ·çš„.

ä¸‹é¢æ¢³ç†ä¿¡å·æœºåˆ¶ï¼š

`SignalFlags` æ˜¯ç”± `bitflags` å®šä¹‰çš„ä¿¡å·é›†åˆï¼Œå„ç§ä¿¡å·. `SigOp` æ˜¯ `SignalFlags::default_op()` æ ¹æ®ä¸åŒä¿¡å·ä½œå‡ºçš„å¤„ç†æ“ä½œçš„ä¸€ä¸ªæšä¸¾ç±»å‹. è¿™ä¸ªæ˜¯å®šä¹‰éƒ¨åˆ†. `SigAction` æ˜¯ä¿¡å·å¤„ç†çš„ç»“æ„ä½“ï¼Œ`sa_handler` å³ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å‡½æ•°, `sa_flags` å³ç›¸åº”çš„æ ‡å¿—ä½, `sa_restorer` ä¸ºå½“ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å‡½æ•°è¿è¡Œå®Œæ¯•åè·³è½¬çš„åœ°å€, `sa_mask` ä¸ºè¿è¡Œè¯¥ä¿¡å·å¤„ç†å‡½æ•°æ—¶éœ€è¦é˜»å¡çš„ä¿¡å·.

```rust
#[repr(C)]
#[derive(Clone, Copy, Debug)]
pub struct SigAction {
    pub sa_handler: usize,
    pub sa_flags: SigActionFlags,
    pub sa_restore: usize,
    pub sa_mask: SignalFlags,
}
```

`KSigAction` æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰æ ‡å¿—åˆ¤æ–­æ˜¯å¦ä½¿ç”¨é»˜è®¤å¤„ç†å‡½æ•°.

```rust
#[derive(Clone, Copy)]
pub struct KSigAction {
    pub act: SigAction,
    pub customed: bool,
}

impl KSigAction {
    pub fn ignore() -> Self {
        Self {
            act: SigAction {
                sa_handler: 1,
                sa_flags: SigActionFlags::empty(),
                sa_restore: 0,
                sa_mask: SignalFlags::empty(),
            },
            customed: false,
        }
    }
}
```

`SigTable`  ç»´æŠ¤ä¸€ä¸ªä¿¡å·è¡¨ï¼Œå°è£… `SigTableInner`ï¼Œ`group_exit_code` æ˜¯ä¸€ä¸ªè¿›ç¨‹å†…å¤šä¸ªçº¿ç¨‹çš„é€€å‡ºç . `actions` å³æ˜¯ä¿¡å·è¡¨æœ¬èº«æ ¹æ®ä¿¡å·ç¼–å·è°ƒç”¨å¯¹åº”å¤„ç†å‡½æ•°.

```rust
pub struct SigTableInner {
    actions: [KSigAction; SIG_MAX_NUM + 1],
    group_exit_code: Option<i32>,
}

impl SigTable {
	...
    pub fn action(&self, signo: usize) -> KSigAction {
        self.get_ref().actions[signo]
    }
    pub fn set_action(&self, signo: usize, act: KSigAction) {
        self.get_mut().actions[signo] = act
    }
    pub fn exit_code(&self) -> i32 {
        self.get_ref().group_exit_code.unwrap()
    }
    ...
}
```

<span id="signal"></span>

å†…æ ¸å¯¹ä¿¡å·çš„å¤„ç†å¦‚ä¸‹ï¼Œå¼•è‡ª[[Linuxä¸­çš„ä¿¡å·å¤„ç†æœºåˆ¶ äºŒ] - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/79062142)ï¼š

<img src="https://pica.zhimg.com/v2-dffe4da0dc9611f74eaa5463c328a022_1440w.jpg" style="zoom:100%;" />

`handle_signal()` å°±æ˜¯å†…æ ¸ä¸­çš„ä¿¡å·å¤„ç†å‡½æ•°.

```rust
pub fn handle_signal(signo: usize) {
    let task = current_task().unwrap();
    let process = task.process.upgrade().unwrap();
    let inner = process.inner_exclusive_access();
    let signal = SignalFlags::from_sig(signo);
    let sig_action = inner.sig_table.action(signo);
    drop(inner);
    let mut task_inner = task.inner_exclusive_access();
    task_inner.sig_pending.remove(signal);
    drop(task_inner);
    drop(task);
    if sig_action.customed {
        setup_frame(signo, sig_action);
    } else {
        if sig_action.act.sa_handler != 1 {
            if sig_action.act.sa_handler == exit_current_and_run_next as usize {
                exit_current_and_run_next((signo + 128) as i32);
            }
        }
    }
}
```

åœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°±ç–‘æƒ‘ä¸ºä»€ä¹ˆä¸€ä¸ªæ›´ç¬¦åˆç›´è§‰çš„ ch8 ä¸­å°† `ProcessControlBlock` å’Œ `TaskControlBlock` åˆ†ç¦»çš„æ–¹æ³•ä¸æ˜¯ä¸€ä¸ªæ›´ä¸ºæ™®éé‡‡ç”¨çš„æ–¹æ³•ï¼Œåæ¥æˆ‘æŸ¥è¯¢äº†[Linux æºç ](https://elixir.bootlin.com/linux/v5.10.65/source/include/linux/sched.h#L648)ï¼Œæ‰å‘ç° `TaskControlBlock` æ‰æ˜¯æ›´é€šç”¨çš„. æ—¢ç„¶ä½¿ç”¨äº†åŒä¸€ä¸ªç»“æ„ä½“ï¼Œé‚£ä¹ˆæ˜¯æ€ä¹ˆåŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹çš„å‘¢ï¼Ÿ

æ­¤æ—¶æ‰å‘ç°å½“éœ€è¦è‡ªå·±è®¾è®¡å†…æ ¸çš„æ—¶å€™ï¼Œè‡ªç„¶åœ°éœ€è¦è€ƒè™‘ **WHY çš„é—®é¢˜**è€Œä¸æ˜¯ WHAT å’Œ HOW. è€Œä¸€èˆ¬çš„æ•™ç¨‹è¦ä¹ˆå‘Šè¯‰ WAHT è¦ä¹ˆå‘Šè¯‰ HOWï¼Œè€Œå¾ˆå°‘æœ‰å‘Šè¯‰ WHY çš„é—®é¢˜.

### 2025.7.4

æˆ‘çš„ç†è§£æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹å…±åŒä¸€ä¸ª `ProcessControlBlock`ï¼Œä¹Ÿå³ Linux  ä¸‹çš„ `task_struct`. æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ `pid`, `tid` å’Œ `ppid`. åœ¨ Linux ä¸‹æœ‰ `tgid` å’Œ `pid` çš„åŒºåˆ†ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ `pid` è€Œå…¶ `tgid` ä¸ä¸»çº¿ç¨‹çš„ `pid` ç›¸ç­‰ï¼Œå¯ä»¥å‚è€ƒ [è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ« ( LINUXç³»ç»Ÿ )](https://blog.csdn.net/whahu1989/article/details/83153191) ä¸­çš„ä¾‹å­. ç”šè‡³å¯ä»¥è¯´è¿™ä¸¤è€…çš„åŒºåˆ«å¹¶ä¸é‚£ä¹ˆé‡è¦ï¼Œå½“æˆ‘ä½¿ç”¨ `PID2PCB` çš„æ—¶å€™å°±å–äº†ä¸€ä¸ªå¸¦æœ‰è¿›ç¨‹å· `pid` çš„çº¿ç¨‹.

```rust
lazy_static! {
    /// PID2PCB instance (map of pid to pcb)
    pub static ref PID2PCB: UPSafeCell<BTreeMap<usize, Arc<ProcessControlBlock>>> =
        unsafe { UPSafeCell::new(BTreeMap::new()) };
}
```

`exit_code` ç°åœ¨è¢«å­˜æ”¾åœ¨ `SigTable` ä¸‹.

### 2025.7.5

å°è¯•ä½¿ç”¨ polyhal åº“è¿›è¡Œä¿®æ”¹. å‚è€ƒ [yfblock/rcore-tutorial-v3-with-hal-component](https://github.com/yfblock/rcore-tutorial-v3-with-hal-component).

ç›®å‰æˆ‘ä»¬çš„ `ProcessControlBlock::new()` é‡Œé¢æœ‰ä¸€ä¸ª `user` é€»è¾‘ï¼Œæ„Ÿè§‰æ”¾åœ¨å’Œ `pid` åŒçº§ä¸æ˜¯å¾ˆå¥½ï¼Œä¹‹åæˆ–è®¸è€ƒè™‘æ”¾åœ¨ `inner` é‡Œé¢.

Trap ä¸Šä¸‹æ–‡ `trap_cx` çš„çš„ä¿å­˜å°±ç”¨ `TrapFrame::new()` åˆ†é…ä¸€ä¸ªé¡µå¸§. `task_cx` å°±ç”¨ `KContext` å°†å†…æ ¸æ ˆçš„æ ˆé¡¶å­˜åœ¨ `KContext` é‡Œ.

### 2025.7.6

å¤„ç†å­¦æ ¡çš„äº‹åŠ¡.

### 2025.7.7

ä¸ºä»€ä¹ˆå¾€å¹´çš„å†…æ ¸å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ `data_flow!` å‘¢ï¼Ÿæˆ–è€…ä¸å¦‚è¯´ `translate_refmut` æ˜¯åœ¨åšä»€ä¹ˆäº‹æƒ…ï¼Ÿåšçš„æ˜¯å°†å…¶ä»–åœ°å€ç©ºé—´çš„ `ptr` è½¬æ¢ä¸ºå†…æ ¸åœ°å€ç©ºé—´çš„ä¸€ä¸ªå¯å˜ `u8 slice`. è¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯å› ä¸ºå…¶è·³æ¿é¡µæˆ–è€…è¯´åŒé¡µè¡¨æœºåˆ¶è®©å†…æ ¸åœ°å€ç©ºé—´å’Œç”¨æˆ·åœ°å€ç©ºé—´å®Œå…¨éš”ç¦»å¼€æ¥. è¿™ä¸ªåœ°æ–¹ä¹‹åå†æ”¹åŠ¨.

å°†å‡ ä¸ªå…³é”®çš„æ–¹æ³•ä¾‹å¦‚ `new`, `exec` å’Œ `fork` å®ç°äº†. 

### 2025.7.8

æ¸…é™¤äº† `ProcessControlBlock` çš„ä¸€äº›æ— ç”¨æˆå‘˜.

polyhal è‡ªå·±æœ‰ä¸€ä¸ª `PageTable`ï¼ŒåŒæ—¶ä¹Ÿå®šä¹‰äº†å„ç§åœ°å€æ®µ. æ„Ÿè§‰å¦‚æœä½¿ç”¨ä»–ä»¬çš„é¡µè¡¨é‚£æ”¹åŠ¨å°±å¤ªå¤§äº†. ä¸è¿‡ LA å’Œ RV å¯ä»¥æ›´å¥½åšä¸€ä¸ªå…¼å®¹.

`TaskControlBlock` å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸è¿‡æˆ‘è¿™é‡Œéƒ½å«å®ƒ `ProcessControlBlock`ï¼Œå®é™…ä¸Šæœ‰ç‚¹ä¸å¯¹.

Trap éƒ¨åˆ†å’Œåœ°å€ç©ºé—´çš„é«˜åœ°å€è¿˜æ²¡åšå¥½ï¼Œä½†æ˜¯æƒ³è®©ä»–å…ˆè¿‡ç¼–è¯‘. å®é™…ä¸Šè¿™äº›éƒ¨åˆ†æ”¹åŠ¨å¤ªå¤§ï¼Œé™¤äº† `KContext` è¿˜æœ‰ `TrapFrame`.

é˜Ÿå‹è¯´å› ä¸ºå‚è€ƒå®ç°çš„æ‡’åˆ†é…æœºåˆ¶å’Œä¸€éƒ¨åˆ†æˆ‘ä»¬è‡ªå·±å®ç°çš„å®åˆ†é…æœºåˆ¶ï¼Œæˆ‘ä»¬çš„è¿›ç¨‹åœ¨ `clone` æ—¶ä¼šé‡åˆ°æ²¡æœ‰å¤„ç† COW ä½çš„é—®é¢˜ï¼Œå­è¿›ç¨‹å¤åˆ¶çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¼šå› ä¸ºè¿™ä¸ªä½çš„åˆ¤æ–­ä»è€Œè§¦å‘ PageFault é”™è¯¯.

### 2025.7.9

æ”¹ `KContext` å’Œ `TrapFrame`. é¦–å…ˆå…ˆæ˜æ™° `task_cx` ä»»åŠ¡ä¸Šä¸‹æ–‡æ˜¯è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œè€Œ `trap_cx` æ˜¯å¤„ç†å™¨å‘ç”Ÿä¸­æ–­ã€å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨ç­‰æ—¶çš„ä¸Šä¸‹æ–‡.

ç°åœ¨æœ‰ä¸‰ç§ä¸åŒçš„ä¸Šä¸‹æ–‡å¤„ç†å®ç°ï¼Œæ•´ç†ä¸€ä¸‹ `task_cx` æ‰€åšçš„äº‹æƒ…ï¼š

åœ¨æ–°å»ºä¸€ä¸ª `TaskContext` æˆ–è€…è¯´ `KContext` å®é™…ä¸Šåšçš„æ˜¯ç±»ä¼¼çš„äº‹æƒ…ï¼Œéƒ½æ˜¯å®šä¹‰ `ra`, `sp` å’Œé€šç”¨å¯„å­˜å™¨

```rust
pub fn goto_trap_loop(kstack_ptr: usize) -> Self {
    Self {
        ra: trap_loop as usize,
        sp: kstack_ptr,
        s: [0; 12],
    }
}

fn blank_kcontext(ksp: usize) -> KContext {
    let mut kcx = KContext::blank(); // såœ¨æ­¤è¢«å»ºç«‹äº†
    kcx[KContextArgs::KPC] = task_entry as usize;
    kcx[KContextArgs::KSP] = ksp;
    kcx[KContextArgs::KTP] = read_current_tp();
    kcx
}
```

`trap_loop as usize` çš„æ“ä½œæ˜¯è¿”å›ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨åç»­è®©å…¶è¿›è¡Œè·³è½¬. ä¹‹åå°±æ˜¯è¿›å…¥å¯¹åº”çš„å¤„ç†å‡½æ•°äº†ï¼š

```rust
#[no_mangle]
pub fn trap_loop() {
    loop {
        trap_return();
        trap_handler();
    }
}

fn task_entry() {
    trace!("os::task::task_entry");
    let task = current_task()
        .unwrap()
        .inner
        .exclusive_access()
        .get_trap_cx() as *mut TrapFrame;
    // run_user_task_forever(unsafe { task.as_mut().unwrap() })
    let ctx_mut = unsafe { task.as_mut().unwrap() };
    loop {
        run_user_task(ctx_mut); // polyhalçš„å†…ç½®å‡½æ•°
    }
}
```

`trustos` çš„ Trap å¤„ç†æ¶‰åŠæ›´å¤šï¼š

```rust
#[no_mangle]
pub fn trap_return() {
    //æ£€æŸ¥ä¿¡å·
    if let Some(signo) = check_if_any_sig_for_current_task() {
        debug!("found signo in trap_return");
        handle_signal(signo);
    }

    if scause::read().cause() == Trap::Interrupt(scause::Interrupt::SupervisorTimer) {
        set_next_trigger();
    }

    // log::info!("return to user");

    set_user_trap_entry();
    extern "C" {
        #[allow(improper_ctypes)]
        fn __return_to_user(cx: *mut TrapContext);
    }
    unsafe {
        // æ–¹ä¾¿è°ƒè¯•è¿›å…¥__return_to_user
        let trap_cx = current_trap_cx();
        // debug!("return to user,trap_ctx={:?}", trap_cx);
        __return_to_user(trap_cx);
    }
}

#[no_mangle]
/// handle an interrupt, exception, or system call from user space
pub fn trap_handler() {
    //è®°å½•ç”¨æˆ·ç©ºé—´èŠ±è´¹CPUæ—¶é—´ï¼ŒåŒæ—¶å‡†å¤‡å†…æ ¸ç©ºé—´èŠ±è´¹CPUæ—¶é—´
    current_task()
        .unwrap()
        .inner_lock()
        .time_data
        .update_utime();
    set_kernel_trap_entry();
    let scause = scause::read();
    let stval = stval::read();
    match scause.cause() {
        ...
    }
    //æ£€æŸ¥å®šæ—¶å™¨
    current_task().unwrap().check_timer();

    //è®°å½•å†…æ ¸ç©ºé—´èŠ±è´¹CPUæ—¶é—´ï¼ŒåŒæ—¶å‡†å¤‡ç”¨æˆ·ç©ºé—´èŠ±è´¹CPUæ—¶é—´
    current_task()
        .unwrap()
        .inner_lock()
        .time_data
        .update_stime();
}
```

rCore åŸæ¥åº”è¯¥æ˜¯è°ƒç”¨ `trap_handler` ç„¶ååœ¨æœ«å°¾è°ƒç”¨ `trap_return` çš„. `set_user_trap_entry` æ˜¯å¤„ç†åœ°å€ç©ºé—´ä¸ä¸€è‡´çš„é—®é¢˜çš„åŠæ³•ï¼Œè¯¦è§[åŸºäºåœ°å€ç©ºé—´çš„åˆ†æ—¶å¤šä»»åŠ¡](https://learningos.cn/rCore-Camp-Guide-2025S/chapter4/6multitasking-based-on-as.html?highlight=set_user_trap_entry#trap). `stvec` æ˜¯ Supervisor Trap Vector Base Address Register.

åœ¨ç”¨æˆ·è¿›ç¨‹è¿è¡Œæ—¶ï¼Œ`stvec` åº”è¯¥æŒ‡å‘ `__trap_from_user` ä½œä¸º ç”¨æˆ·é™·é˜±å…¥å£ã€‚å½“ç”¨æˆ·æ€å‘ç”Ÿé™·é˜±ï¼ˆä¸­æ–­ã€å¼‚å¸¸ã€ç³»ç»Ÿè°ƒç”¨ï¼‰æ—¶ï¼ŒCPUä¼šè·³è½¬åˆ° `__trap_from_user`.

```assembly
# user -> kernel
__trap_from_user:
    csrrw sp, sscratch, sp
    # now sp->*TrapContext in kernel space, sscratch->user stack
    # save other general purpose registers
    sd x1, 1*8(sp)
    # skip sp(x2), we will save it later
    # save x3~x31 (x4 is tp)
```

`__trap_from_user` å°±æ˜¯å°†æ‰€æœ‰çš„**ç”¨æˆ·å¯„å­˜å™¨**å­˜åˆ°**å†…æ ¸æ ˆ**ï¼Œå’Œ`polyhal` çš„ `user_restore` æ˜¯ç±»ä¼¼çš„. `__return_to_user` è‡ªç„¶å°±æ˜¯åœ¨å†…æ ¸æ ˆä¸Šæ¢å¤ç”¨æˆ·å¯„å­˜å™¨äº†.

å¯¹äºä¿¡å·æœºåˆ¶ï¼Œæˆ‘çš„ç†è§£æ˜¯è¿›å…¥ `trap_loop` å·²ç»æ˜¯è¿›å…¥äº†å†…æ ¸æ€ï¼Œç„¶ååœ¨ `trap_return` é‡Œè¿›è¡Œä¿¡å·å¤„ç†è°ƒç”¨ `handle_signal`ï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…ä¼šå…ˆ `setup_frame` ä¿å­˜å†…æ ¸çš„ä¸Šä¸‹æ–‡åœ¨**ç”¨æˆ·æ ˆ**ä¸Š. å› ä¸ºæ ¹æ®[å…ˆå‰](#signal)æ‰€è¯´çš„ä¿¡å·å¤„ç†çš„æœºåˆ¶å®é™…ä¸Šæ˜¯åœ¨ç”¨æˆ·æ€è¿›è¡Œçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦è·³è½¬åˆ°ç”¨æˆ·æ€ï¼Œç„¶åä»ç”¨æˆ·æ€æ¢å¤å½“å‰çš„ä¸Šä¸‹æ–‡ï¼Œè¿™å°±å†³å®šäº†æ˜¯ä»è¢«è·³è½¬çš„æ€çš„æ ˆä¸Šä¹Ÿå°±æ˜¯ç”¨æˆ·æ ˆä¸Šæ¢å¤äº†æˆ‘ä»¬åŸæ¥çš„æ€çš„ä¸Šä¸‹æ–‡ä¹Ÿå°±æ˜¯å†…æ ¸æ€.

é‚£ä¸ºä»€ä¹ˆå…ˆå¤„ç†ä¿¡å·åè®¾ç½®ç”¨æˆ·è¿”å›å…¥å£ç„¶åå°±è¿”å›äº†ï¼Œå­˜ç–‘ï¼Ÿé‚£ä»€ä¹ˆæ—¶å€™è¿›å…¥å†…æ ¸çš„ `trap_handler` å¤„ç†ï¼Ÿçœ‹èµ·æ¥æ˜¯ä¸ºäº†è§£å†³è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿçš„é—®é¢˜æ‰€ä»¥å…ˆè¿”å›äº†ä¸€æ¬¡ç”¨æˆ·æ€. æ„Ÿè§‰æ€ªæ€ªçš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™.

`polyhal` çš„å†…ç½®å‡½æ•°å®šä¹‰å¾ˆæ¸…æ™°ï¼Œåˆ†ä¸ºå­˜ç”¨æˆ·ä¸Šä¸‹æ–‡å’Œä»å†…æ ¸å›è°ƒä¸¤ä¸ªéƒ¨åˆ†ï¼š

```rust
pub fn run_user_task(context: &mut TrapFrame) -> EscapeReason {
    user_restore(context); //åŒ…è£¹ä¿å­˜å¯„å­˜å™¨çš„asm
    kernel_callback(context).into() // ä¸­æ–­å¼‚å¸¸ï¼Œç±»ä¼¼äºtrap_handler
}
```

ä½†æ— è®ºæ˜¯å“ªç§å®ç°ï¼Œåœ¨ Trap è¿”å›æ—¶éƒ½æ˜¯éœ€è¦è·å–å½“å‰çš„ `TrapContext` æˆ–è€…è¯´ `TrapFrame` çš„ï¼Œé€šè¿‡è°ƒç”¨ `get_trap_cx` æˆ–è€… `current_trap_cx` è¿™ç§ç±»ä¼¼çš„å‡½æ•°æ¥å®ç°. å…¶å®å¾ˆç¬¦åˆé€»è¾‘ï¼Œå› ä¸º Trap åˆ°å¦ä¸€ä¸ªæ€å°±æ˜¯éœ€è¦å½“å‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯çš„.

é‚£ä¹ˆè‡ªç„¶çš„é—®é¢˜æ˜¯ï¼Œ`TrapContext` å’Œ `TaskContext` æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿé¦–å…ˆæ˜¯å­˜æ”¾ä½ç½®çš„åŒºåˆ«ï¼Œ`TrapContext` ä¸€èˆ¬åœ¨å†…æ ¸æ ˆæ ˆé¡¶ï¼Œ`TaskContext` ä¸€èˆ¬åœ¨ä»»åŠ¡æ§åˆ¶å—é‡Œ. ç›¸æ¯”äº `TrapContext`ï¼Œ`TaskContext` åªä¿å­˜ä¸€äº›æ¯”è¾ƒé‡è¦çš„å¯„å­˜å™¨è€Œä¸æ˜¯å…¨éƒ¨çš„çŠ¶æ€ä¿¡æ¯. è€Œä¸”ä»–ä»¬çš„ç›®æ ‡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œ`TrapContext` æ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢é—®é¢˜ï¼Œå®ç°ä¾èµ– CPU çš„é™·é˜±æœºåˆ¶ï¼Œè€Œ `TaskContext` æ˜¯å†…æ ¸æ€ä»»åŠ¡çš„ä¸»åŠ¨åˆ‡æ¢ï¼Œä¾é çš„æ˜¯ `__switch` è¿™ä¸€çº¯è½¯ä»¶çš„å®ç°æ–¹å¼.

| **ç‰¹æ€§**       | `trap_context`                        | `task_context`                   |
| :------------- | :------------------------------------ | :------------------------------- |
| **è§¦å‘æ—¶æœº**   | ç”¨æˆ·æ€â†’å†…æ ¸æ€çš„é™·é˜±ï¼ˆä¸­æ–­/å¼‚å¸¸ï¼‰      | å†…æ ¸æ€ä»»åŠ¡ä¸»åŠ¨åˆ‡æ¢               |
| **ä¿å­˜ä½ç½®**   | å½“å‰ä»»åŠ¡çš„å†…æ ¸æ ˆé¡¶                    | ä»»åŠ¡æ§åˆ¶å—ï¼ˆTCBï¼‰                |
| **æ•°æ®å®Œæ•´æ€§** | å®Œæ•´ç”¨æˆ·çŠ¶æ€ + é™·é˜±å…ƒæ•°æ®             | ä»…åˆ‡æ¢æ‰€éœ€çš„å…³é”®å¯„å­˜å™¨           |
| **æ¢å¤ç›®æ ‡**   | è¿”å›åŸç”¨æˆ·ä»»åŠ¡                        | åˆ‡æ¢åˆ°å¦ä¸€ä¸ªå†…æ ¸ä»»åŠ¡             |
| **ç¡¬ä»¶ä¾èµ–**   | ä¾èµ– CPU çš„é™·é˜±æœºåˆ¶ï¼ˆå¦‚ RISC-V Trapï¼‰ | çº¯è½¯ä»¶å®ç°ï¼ˆå¦‚ `__switch` å‡½æ•°ï¼‰ |

ä¸€ä¸ª `__switch` ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼š

```rust
global_asm!(include_str!("switch.S"));

extern "C" {
    pub fn __switch(current_task_cx_ptr: *mut TaskContext, next_task_cx_ptr: *const TaskContext);
}
```

ä¸ºäº†ç»™ `polyhal` åŠ å…¥ä¿¡å·å¤„ç†çš„æœºåˆ¶ï¼Œéœ€è¦è®© `TrapFrame` èƒ½ä¸æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ `MachineContext` å’Œ `UserContext` èƒ½å¤Ÿå®ç°è½¬æ¢. è¯•äº†è®¸å¤šæ–¹æ³•ï¼Œæœ€åæ„Ÿè§‰è¿˜æ˜¯å®ç°ä¸€ä¸ª `trait` å† `impl` å…¶ä¸Šæ¯”è¾ƒç®€å•.

`trap_cx` åº”è¯¥æœ‰ä¸€ä¸ª `origin_a0` çš„æœºåˆ¶ï¼Œåœ¨å¤„ç†ä¿¡å·ä¸º `SA_RESTART` æ—¶è¿›è¡Œå¤„ç†ï¼Œè¿™éœ€è¦æ”¹ `polyhal` åº•å±‚ï¼Œç›®å‰å…ˆè®©å…¶è¿‡ç¼–è¯‘ï¼Œä¹‹åç”¨åˆ°äº†å†ä¿®æ”¹.

> 2025.8.15ï¼šä¿è¯ç¨‹åºæ­£ç¡®æ€§åº”è¯¥æ˜¯ç¬¬ä¸€ä½çš„ï¼Œåœ¨å†…æ ¸ä¸Šåšå¦‚æ­¤å¤§çš„æ”¹åŠ¨å¹¶ä¸åˆé€‚ï¼Œä¸èƒ½è¯´åªæ˜¯å…ˆè¿‡äº†ç¼–è¯‘å°±æ”¾ç€ä¸ç®¡äº†.

### 2025.7.10

å¦‚æœç›´æ¥ä½¿ç”¨ `polyhal-boot` ä¼šæœ‰ `PageTable` çš„é—®é¢˜ï¼Œå°±å¾—ç”¨ä»–ä»¬çš„æ•°æ®ç»“æ„äº†. æ‰€ä»¥å¯åŠ¨çš„éƒ¨åˆ†è¿˜æ˜¯å¾—è‡ªå·±æ”¹.

ä½†æ˜¯æƒ³è¦å¯åŠ¨èµ·æ¥å°±å¿…é¡»åˆ å»è·³æ¿é¡µï¼š

```assembly
rust-lld: error: undefined symbol: trampoline
          >>> referenced by os.e36b250b2cfb0a60-cgu.13
          >>>               /home/lc/osrepo/os/target/riscv64gc-unknown-none-elf/release/deps/os-d7d907be1afa0e3a.os.e36b250b2cfb0a60-cgu.13.rcgu.o:(.text.entry+0x2E)
          >>> did you mean: strampoline
          >>> defined in: src/linker_rv.ld:14
```

ç„¶åå°±åˆ å»äº†è·³æ¿é¡µï¼Œå‹‰å¼ºè¿‡äº†ç¼–è¯‘ï¼Œä½†æ˜¯å†…æ ¸æ— æ³•å¯åŠ¨ï¼Œå¡åœ¨ OpenSBI å¤„.

### 2025.7.11

è®¾ç½® `BASE_ADDRESS = 0xffffffc080200000`ï¼Œä½†æ˜¯å†…æ ¸æ— æ³•å¯åŠ¨. éš¾ä»¥ç†è§£ï¼Œç›¸å½“äºæ²¡æœ‰è¿›å…¥å†…æ ¸ï¼Œä½†æ˜¯é“¾æ¥è„šæœ¬å’Œ `boot` éƒ½çœ‹èµ·æ¥æ²¡ä»€ä¹ˆé—®é¢˜.

åœ¨é“¾æ¥è„šæœ¬é‡Œè®¾ç½® `BASE_ADDRESS` ä¸ºä½åœ°å€å°±å¯ä»¥å¯åŠ¨äº†ï¼Œä½†æ˜¯æ‰“å°å‡ºæ¥çš„åœ°å€æ˜ å°„éƒ½æ˜¯é«˜åœ°å€ï¼Œè¿™æ˜¯å¦æœ‰ç‚¹ç¦»è°±äº†. éš¾é“è¿™ä¸ªä¸å°±æ˜¯å†…æ ¸çš„å…¥å£èµ·å§‹åœ°å€å—ï¼Ÿ

æ ¹æ® [TrustOS çš„è®¾è®¡æ–‡æ¡£](https://gitee.com/B4holder/trust-os/blob/final/chapter2_å†…å­˜ç®¡ç†.md) å’Œ [chaos å¼€å‘æ—¥å¿—](https://sazikk.top/posts/å¼€å‘æ—¥å¿—-chaoså¼€å‘æ—¥å¿—/#ä¿®æ”¹å†…æ ¸åœ°å€ç©ºé—´)ï¼Œè®¾ç½® `BASE_ADDRESS` ä¸åº”è¯¥æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘åªèƒ½ç†è§£ä¸ºæ˜¯ `RustSBI` å’Œ `OpenSBI` çš„å·®å¼‚. æ ¹æ® TrustOS æ–‡æ¡£çš„è¯´æ³•ï¼Œæ”¹å˜å†…æ ¸å…¥å£å¹¶ä¸ä¼šå½±å“åˆ°ç‰©ç†å†…å­˜ä¸­ç”± `0x8020_0000` å¼€å§‹çš„ä¸€æ®µï¼Œæ‰€ä»¥å³ä½¿å†…æ ¸å…¥å£å·²ç»è®¾ç½®ä¸ºäº†é«˜ä½çš„è™šæ‹Ÿåœ°å€ï¼Œæ‰€ä»¥å†…æ ¸è¿˜æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„ï¼Œåªéœ€è¦è€ƒè™‘å¯åŠ¨è™šæ‹Ÿæ˜ å°„ä¹‹åå°†ä»£ç æ˜ å°„åˆ°é«˜ä½. ä½†å¦‚æœ `OpenSBI` å¹¶ä¸æ˜¯ç›¸åŒçš„é€»è¾‘ï¼Œè€Œæ˜¯å°±æ ¹æ®é“¾æ¥è„šæœ¬å®šä¹‰çš„è™šæ‹Ÿåœ°å€æ¥å¯»æ‰¾ `_start` å„æ®µï¼Œé‚£ä¹ˆè®¾ç½®äº†é«˜åœ°å€çš„ `BASE_ADDRESS` å°±ä¼šè®©æ‰€æœ‰ç¬¦å·è¯¸å¦‚ `_start = 0xffffffc080200000` ä¸ºé«˜ä½çš„è™šæ‹Ÿåœ°å€ï¼ŒåŒæ—¶ `boot` ä¸­æ‰€åšçš„æ˜ å°„é«˜ä½çš„å¤§é¡µæœºåˆ¶ä¸­è¯¸å¦‚ `sp` å’Œ `t0` ä¹Ÿå°±è‡ªåŠ¨è¢«è®¤ä¸ºæ˜¯é«˜ä½åœ°å€äº†ï¼Œå› ä¸º `la` æŒ‡ä»¤åŠ è½½çš„æ˜¯ç”±é“¾æ¥è„šæœ¬å†³å®šçš„ç¬¦å·çš„è™šæ‹Ÿåœ°å€.

```assembly
la sp, boot_stack_top   # sp = é«˜è™šæ‹Ÿåœ°å€ (0xffffffc0802xxxxx)
la t0, boot_pagetable   # t0 = é«˜è™šæ‹Ÿåœ°å€ (0xffffffc0802xxxxx)
```

å› ä¸ºåœ¨å†…æ ¸åˆšåŠ è½½çš„ä¸€æ®µæ—¶é—´åˆ†é¡µæœºåˆ¶è¿˜æ²¡æœ‰å¼€å¯ï¼Œæ‰€ä»¥ä¸€ç›´éƒ½æ˜¯åœ¨è®¿é—®ç‰©ç†åœ°å€ï¼Œè®¿é—®é«˜è™šæ‹Ÿåœ°å€è‡ªç„¶å°±ä¼šå¼•å‘é”™è¯¯ï¼Œæ— æ³•å¤„ç†å¯¼è‡´å¡æ­».

å¦‚æœåœ¨ `FRAME_ALLOCATOR` ä¸­è®¾ç½®

```rust
FRAME_ALLOCATOR.exclusive_access().init(
    // Frame allocator initialized: 0xffffc082272 - 0xffffc088000
    PhysAddr::from(ekernel as usize).ceil(),
    PhysAddr::from(MEMORY_END).floor(),
);
```

è€Œä¸æ˜¯

```rust
FRAME_ALLOCATOR.exclusive_access().init(
    // Frame allocator initialized: 0x82272 - 0x88000
    PhysAddr::from(KernelAddr::from(ekernel as usize)).ceil(),
    PhysAddr::from(KernelAddr::from(MEMORY_END)).floor(),
);
```

å°±ä¼šå¯¼è‡´å†…æ ¸å¡æ­»ï¼Œ`KernelAddr` æ˜¯å¯¹ `usize` çš„ç›´æ¥åŒ…è£¹ï¼Œåªç”¨æ¥æ³¨æ˜è¿™æ˜¯å†…æ ¸çš„é«˜åœ°å€ç©ºé—´ï¼Œè½¬æ¢ä¸º `PhysAddr` æ—¶ç›´æ¥å‡å» `KERNEL_ADDR_OFFSET`. å¯¹äºç‰©ç†é¡µå¸§åˆ†é…å™¨ï¼Œéœ€è¦çš„ç¡®å®åº”å½“æ˜¯ä½ä½çš„ç‰©ç†åœ°å€è€Œä¸æ˜¯è™šæ‹Ÿåœ°å€.

ä½†æ˜¯åœ¨ `activate` é‡Œå†™å…¥ `satp` å°±ä¼šå¡æ­»ï¼š

```rust
pub fn activate(&self) {
    let satp = self.page_table.token();
    unsafe {
        satp::write(satp);
        asm!("sfence.vma"); 
    }
}
```

æˆ‘ç†è§£çš„æ˜¯ `ppn` æ®µçš„å†…å®¹ `0x82282` æ²¡æœ‰è¢«æ­£ç¡®æ˜ å°„ï¼Œå¯¼è‡´çš„é—®é¢˜ï¼š

```assembly
kernel satp: 0x8000000000082282
.text [0xffffffc080200000, 0xffffffc080248000)
.rodata [0xffffffc080248000, 0xffffffc080257000)
.data [0xffffffc080257000, 0xffffffc080260000)
.bss [0xffffffc080260000, 0xffffffc082282000)
sigreturn_trampoline : [0xffffffc080202000, 0xffffffc080203000)
physical memory: [0xffffffc082282000,0xffffffc088000000)
...
[ INFO] mapping physical memory
[DEBUG] MapArea::new(as vpn) start floor = 0x4082282, end ceil = 0x4088000
...
create new kernel successfully!
[DEBUG] activate memory set, satp = 0x8000000000082282
[DEBUG] satp = 0x8000000000082282
```

### 2025.7.12

æ²¡ä»€ä¹ˆå¤´ç»ªè§£å†³ï¼Œ`satp` ä¹‹åå†çœ‹.

ç„¶åæ˜¯ `trap` çš„é—®é¢˜. æˆ‘ä»¬ç°åœ¨çš„ `trap` å’Œ `polyhal` çš„æ··åœ¨ä¸€èµ·ï¼Œæ„Ÿè§‰å¯èƒ½æ•´ä¸ªç»“æ„è¿˜æ˜¯å¾—ç”¨ `polyhal` æ¥æ”¹å†™.

æ‰“ç®—æ­£å¼è¿ç§» `polyhal` äº†ï¼Œå› ä¸ºåé¢æ— è®ºæ˜¯ä¸Šæ¿è¿˜æ˜¯å…¶ä½™çš„ä¸€äº›åŠŸèƒ½çš„å®ç°éƒ½ä¼šç”¨åˆ°. é¦–å…ˆè¦åšçš„å°±æ˜¯ä¿®æ”¹é“¾æ¥è„šæœ¬. `polyhal` ç¡®å®å†™çš„è¿˜ä¸é”™ï¼Œå¯åŠ¨çš„éƒ¨åˆ†å¾ˆå¥½æ‡‚. 

ç”¨ `polyhal` å¯åŠ¨äº†å†…æ ¸.

### 2025.7.13

`polyhal` æ¥å®ç°åœ°å€ç©ºé—´ï¼Œ`PageTable` çš„éƒ¨åˆ†æ˜¯ä»–ä»¬å·²ç»å®ç°äº†çš„ï¼Œæ‰€æœ‰ `MapArea` ç›¸å…³çš„éƒ¨åˆ†è¿˜ä¿å­˜ç€.

ä½†æ˜¯æ‰€æœ‰æ¶‰åŠ `PageNum` çš„éƒ¨åˆ†éƒ½éœ€è¦ä¿®æ”¹. å…ˆå‰çš„ rCore æ˜¯ç”¨ `floor` å’Œ `ceil` æ–¹æ³•æ¥å®ç°ç”±åœ°å€å‘é¡µå·çš„è½¬æ¢ï¼Œè¿™é‡Œ `polyhal` è™½ç„¶ä¹Ÿä½¿ç”¨äº†åŒåçš„æ–¹æ³•ï¼Œä½†æ˜¯è¿”å›å€¼ä»ç„¶æ˜¯åœ°å€è€Œä¸æ˜¯é¡µå·. å˜é‡åè™½ç„¶è¿˜æ˜¯ `vpn`ï¼Œä½†æ˜¯æ˜¯ç»è¿‡**é¡µå¯¹é½**è¿‡åçš„ `VirtAddr`. é¡µè¡¨çš„ `translate` æ–¹æ³•å˜ä¸ºï¼š

```rust
polyhal::pagetable::PageTable
pub fn translate(&self, vaddr: VirtAddr) -> Option<(PhysAddr, MappingFlags)>
```

è€Œä¸” `MapType` çš„å·®åˆ«ä¹Ÿè¢«åˆ æ‰äº†.

å¾ˆå¥‡æ€ªï¼Œ`polyhal` çš„å®ç°ä¼¼ä¹å¹¶ä¸éœ€è¦ `token`.

æˆ‘ç†è§£çš„æ˜¯ï¼Œç”¨æˆ·æ€å’Œå†…æ ¸æ€æœ‰ä¸¤ä¸ªé¡µè¡¨ï¼Œè¿™å°±æ˜¯[SaZiKK ä¸€ç›´è¯´çš„åŒé¡µè¡¨æœºåˆ¶](https://sazikk.top/posts/å¼€å‘æ—¥å¿—-chaoså¼€å‘æ—¥å¿—/#2024619-å¼€å§‹é‡æ„). å†…æ ¸çš„é¡µè¡¨å°±æ˜¯ `KERNEL_SPACE` ä¸‹çš„é¡µè¡¨ï¼Œå¦‚æœä»–ä»¬å…±ç”¨ä¸€ä¸ªé¡µè¡¨ï¼Œå°±å®Œå…¨é¢ è¦†äº† [è·¨ç©ºé—´è·³æ¿å†…æ ¸](https://rustmagazine.github.io/rust_magazine_2021/chapter_7/trampoline-kernel.html) çš„ç»“æ„. æ‰€ä»¥æå…¶ç²¾ç®€çš„ `translated_byte_buffer` æ˜¯æœ‰åŸå› çš„ï¼š

```rust
pub fn translated_byte_buffer(_token: PageTable, ptr: *mut u8, len: usize) -> &'static mut [u8] {
    trace!("os::mm::page_table::translated_byte_buffer");
    unsafe { core::slice::from_raw_parts_mut(ptr, len) }
}
```

`GROUP_SHARE` åŸæœ¬éƒ½æ˜¯ `ppn` åˆ° `FrameTracker` çš„æ˜ å°„ï¼Œè®°å¾—æ”¹è¿‡æ¥ï¼Œç°åœ¨æ˜¯å¯¹é½è¿‡åçš„ `VirtAddr`. 

ä¿®æ”¹ `MemorySet` æ—¶éƒ½ä¿ç•™äº† `vpn` çš„è¯´æ³•ï¼Œä½†æ˜¯è¿™æ˜¯å¯¹é½è¿‡åçš„è™šæ‹Ÿåœ°å€. 

ä¸€èˆ¬çš„ `VirtAddr` å‘ `VirtPageNum` çš„è½¬æ¢æ˜¯ `floor`.

### 2025.7.14

æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å…¶å¯¹åº”çš„åœ°å€ç©ºé—´ï¼Œè‡ªç„¶ä¹Ÿæœ‰å…¶å¯¹åº”çš„é¡µè¡¨ï¼Œå½“æ—¶ `polyhal` ç›´æ¥åˆ é™¤äº†è¿™ä¸€éƒ¨åˆ†. çŠ¹è±«å¦‚ä½•ä¿®æ”¹ï¼š

```rust
// MemorySetInner::lazy_clone_area
let mut origin_page_table = PageTable::from_token(self.page_table.token());
let another_page_table = PageTable::from_token(another.page_table.token());
for vpn in another_area.vaddr_range {
    let src_pte = another_page_table.translate(vpn);
    if src_pte.is_none() || !src_pte.unwrap().is_valid() {
        continue;
    }
    let src_ppn = src_pte.unwrap().ppn();

    let dst_pte = origin_page_table.translate(vpn);
    if dst_pte.is_none() || !dst_pte.unwrap().is_valid() {
        this_area.map_one(&mut origin_page_table, vpn);
    }
    let dst_ppn = origin_page_table.translate(vpn).unwrap().ppn();
    dst_ppn
    .bytes_array_mut()
    .copy_from_slice(src_ppn.bytes_array());
}
```

é¡µè¡¨çš„åˆ‡æ¢ï¼Œæˆ–è€…è¯´è¿›ç¨‹é¡µè¡¨ `satp` çš„åˆ‡æ¢æ˜¯åœ¨ `TaskControlBlock::exec` é‡Œè°ƒç”¨ `memory_set.activate()` å®ç°çš„.

`PhysAddr` å’Œ `VirtAddr` ä¸éœ€è¦åœ¨ `translated_byte_buffer` å®ç°è½¬æ¢ï¼Œåº”å½“æ˜¯å› ä¸º `VirtAddr` å’Œ `PhysAddr` éƒ½æ˜¯å¯¹ `usize` çš„ç®€å•åŒ…è£¹ï¼Ÿä½†è¿™ä¸å¯¹å§ï¼Œ`translated_byte_buffer` å®é™…ä¸Šæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€è½¬æ¢ä½¿ç”¨åˆ°çš„ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿™æ˜¯å› ä¸ºå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åŒé¡µè¡¨æœºåˆ¶è¢«å–æ¶ˆäº†. å› ä¸ºä¸ç”¨è·³æ¿é¡µäº†.

ç„¶åè¯´å›è¿™ä¸ª `lazy_clone_area` çš„é—®é¢˜ï¼Œå› ä¸ºæ˜¯åœ¨ `clone_user_res` é‡Œè°ƒç”¨ï¼Œå®é™…ä¸Šæ˜¯ä¸åŒè¿›ç¨‹é—´åœ°å€ç©ºé—´çš„å¤åˆ¶ï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯è¦åšé¡µè¡¨åˆ‡æ¢çš„.

`safe_translated_byte_buffer` å®é™…ä¸Šå°±æ˜¯ `translated_byte_buffer` åœ¨æŸ¥æ‰¾ `PageTableEntry`è¿‡ç¨‹ä¸­çš„æƒ°æ€§å¤„ç†. å› ä¸ºå·²ç»å–æ¶ˆäº†å†…æ ¸é¡µè¡¨ä¸åº”ç”¨é¡µè¡¨çš„åŒºåˆ«ï¼Œæ‰€ä»¥æŸ¥æ‰¾é¡µè¡¨é¡¹ä¹Ÿä¸å¿…è¦äº†ï¼Œåˆ .

### 2025.7.15

TrustOS çš„å†…æ ¸æ ˆä¸Šå­˜æ”¾ç€ `task_cx`. åŸæœ¬çš„è®¾è®¡åœ¨ `KERNEL_SAPCE` å’Œç”¨æˆ·çš„ `memory_set` åˆ†åˆ«æ˜ å°„åŒä¸€æ®µé€»è¾‘æ®µåº”å½“æ˜¯ä¸ºäº†åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ä¿æŒåˆç†çš„åœ°å€è®¿é—®.

éœ€è¦é‡å†™æ•´ä¸ªä¿¡å·å¤„ç†æœºåˆ¶ï¼Œä½†æ˜¯ç›®å‰æ¥è¯´è¿˜åšä¸åˆ°ï¼Œè€Œä¸”ä¸çŸ¥é“ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜. å…ˆæ”¾ç€.

ä¸€åˆ‡éƒ½æ”¹å¥½äº†ï¼Œå‘ç° OpenSBI çš„å¯åŠ¨åœ°å€ä¸ä¸€æ ·ï¼Œåç»­çš„åœ°å€ç©ºé—´ä¹Ÿæ— æ³•è¢«æ„å»ºèµ·æ¥

```bash
lc@806-os:~/osrepo$ riscv64-unknown-elf-readelf -h kernel-rv
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 03 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - GNU
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           RISC-V
  Version:                           0x1
  Entry point address:               0xffffffc080200000
  Start of program headers:          64 (bytes into file)
  Start of section headers:          17567816 (bytes into file)
  Flags:                             0x5, RVC, double-float ABI
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         7
  Size of section headers:           64 (bytes)
  Number of section headers:         25
  Section header string table index: 23
```

### 2025.7.16

ä¿®é«˜ä½åœ°å€çš„å¯åŠ¨é—®é¢˜.

é¦–å…ˆå…ˆä¿®å¤äº† vendor é‡Œä¼šé‡å¤å¼•å…¥ polyhal å®çš„é—®é¢˜ï¼Œä¸€ä¸ªå° bug.

ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ— æ³•å°†é“¾æ¥è„šæœ¬é‡Œçš„åœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€.

ç­”ï¼šæ¢æˆ `os.bin` å°±å¯ä»¥äº†. å› ä¸º OpenSBI ä¼šæ ¹æ®æ–‡ä»¶æ ¼å¼è¿›è¡Œè§£æï¼Œå¦‚æœæ˜¯ ELF æ ¼å¼å°±ä¼šæŒ‰ç…§å…¶ Entry çš„è™šæ‹Ÿåœ°å€è¿›è¡ŒåŠ è½½ï¼Œè€Œ bin æ–‡ä»¶ä¼šæ— æ¡ä»¶åŠ è½½åˆ° `0x80200000`.

è‡³æ­¤å¯ä»¥è¯´**åŸºæœ¬**å®Œæˆäº†åˆèµ›ç»“æŸä»¥æ¥çš„é‡æ„.

### 2025.7.17

`KernelAddr::from()` ä¹‹åå† `kernel_va as *mut u8` å’Œ `get_mut_ptr::<u8>()` æ˜¯ä¸€æ ·çš„. ä¿®å¤äº†åŸæœ¬ `bytes_array_mut` ä¸€ç±»çš„é—®é¢˜.

```rust
// dst_ppn
//   .bytes_array_mut()
//   .copy_from_slice(src_ppn.bytes_array());
let src_paddr: *const u8 = src_paddr.get_ptr::<u8>();
let dst_paddr: *mut u8 = dst_paddr.get_mut_ptr::<u8>();
let dst_array = unsafe {
    core::slice::from_raw_parts_mut(dst_paddr, PAGE_SIZE)
};
dst_array.copy_from_slice(
    unsafe {
        core::slice::from_raw_parts(src_paddr, PAGE_SIZE)
    }
);
```

åˆ‡æ¢ä¸Šä¸‹æ–‡æœ‰é—®é¢˜.

### 2025.7.18

æ˜¯ `suspend_current_and_run_next` çš„é—®é¢˜ï¼Œä¼¼ä¹. å› ä¸ºåœ¨é˜»å¡å‰è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°.

ä¸æ˜¯ï¼Œé˜Ÿå‹æ”¹å¥½äº†.

### 2025.7.19

é‡åˆ° `NotReady`ï¼Œæ— æ³•è§£å†³ï¼Œæ²¡å¤ªæ˜ç™½æ˜¯ä»€ä¹ˆåŸå› æŠ¥é”™.

```shell
[ INFO] ##### syscall with id 221 #####
[DEBUG] (sys_exec) current process id is :2
[DEBUG] (sys_exec) trim path ok,the path is :/musl/basic_testcode.sh
[DEBUG] (sys_exec) the argv is :["busybox", "sh", "/musl/basic_testcode.sh", "sh", "/musl/busybox"], the env is :["PATH=/:/bin:", "LD_LIBRARY_PATH=/lib:/lib/glibc:/lib/musl:", "ENOUGH=100000"]
[DEBUG] (sys_exec) the cwd is :/, the path is :/musl/busybox
[DEBUG] (sys_exec) to open file, the abs_path is: /musl/busybox
[DEBUG] (fs::open) open file: /musl/busybox, flags: O_RDONLY
[ INFO] (fs::open) open file: /musl/busybox, but not found in idx
[DEBUG] (ext4_lw, Inode::find) origin path=/musl/busybox
[DEBUG] (exr4_lw, Inode::find) get file successfully
[DEBUG] (ext4_lw, Ext4File::check_inode_exist) path=/musl/busybox, types=EXT4_DE_DIR
[kernel] Panicked at src/drivers/virtio/blk.rs:80 Error when reading VirtIOBlk: NotReady
```

æŠŠ `fs::init` å’Œ `fs::list_apps` æ³¨é‡Šåä¼šåœ¨åˆ†é…æ—¶å¡ä½å¾ˆä¹…. æœ€ååœ¨å¯¹ `block_id` ä¸º 2 çš„è¯»å–æ—¶æŠ¥é”™ NotReady.

åˆ‡æ¢è‡³è¿™ä¸ª [ğŸ› fix:ä¿®å¤ç»™execä¼ å‚ä¸º0x0é—®é¢˜](https://github.com/wdlin233/osrepo/commit/ea840cb221f00f4510c8507b1e822f331a5e0987) commitï¼Œæ³¨é‡Š `fs_list_apps` åæŠ¥é”™

```shell
[DEBUG] add ok
[DEBUG] add ok
[DEBUG] add ok
[DEBUG] add ok
[DEBUG] ptr to string ok
[DEBUG] to deal the argv
[DEBUG] get cwd ok, the cwd is :/, the path is :/musl/busybox
[DEBUG] to open,the path is: /musl/busybox
[DEBUG] Device features: BlkFeature(SEG_MAX | GEOMETRY | BLK_SIZE | SCSI | FLUSH | TOPOLOGY | CONFIG_WCE | DISCARD | WRITE_ZEROES | NOTIFY_ON_EMPTY | RING_INDIRECT_DESC | RING_EVENT_IDX)
[ INFO] config: 0xffffffc010001100
[ INFO] found a block device of size 4194304KB
[ INFO] (frames_alloc) Allocating 2 frames
[ INFO] (frames_alloc) Allocating 2 frames starting at 0x8232a000
[ INFO] New an Ext4 Block Device
[DEBUG] OPEN Ext4 block device p_user=0xffffffc082300c00
[kernel] Panicked at src/drivers/virtio/blk.rs:77 called `Result::unwrap()` on an `Err` value: NotReady
```

æ„å‘³ç€ `VirtIOBlk::new` æŠ¥é”™. è¿™åº”è¯¥æ˜¯åœ¨åˆå§‹åŒ– `fs`ï¼Œä½†ä¸ºä»€ä¹ˆä¸€æ—¦è¿›å…¥ `execve` å°±ä¼šæŠ¥é”™ï¼Ÿ

æ”¹äº†ä¸€ä¼šä¹Ÿæ²¡è§‰å¾—æœ‰ä»€ä¹ˆé—®é¢˜.

ä¼¼ä¹ä¸æ˜¯ deps çš„é—®é¢˜ï¼Œä½†æ–‡ä»¶ç³»ç»Ÿå’Œé©±åŠ¨å±‚ä¹Ÿæ²¡çœ‹å‡ºä»€ä¹ˆé€»è¾‘é”™è¯¯. è€Œä¸”æ¯æ¬¡éƒ½é‚£ä¸€è¡Œé”™è¯¯ï¼Œåœ¨ gdb é‡Œ `ffi` ä¼šæ˜¾ç¤º `not such file or directory`.

### 2025.7.20

æ”¹ loongarch,æŠ¥é”™

```shell
[ INFO] (suspend_current_and_run_next) suspending current task and running next task
[DEBUG] (kernel_intrrupt) page fault handling
[ INFO] (kernel_intrrupt) now handling page fault, paddr = 0x1d000, trap_type = StorePageFault(118784)
[ERROR] [kernel] trap_handler: bad paddr = 0x1d000, kernel killed it.
```

æˆ‘ä»¬ä¹‹å‰åœ¨åˆ†ææ—¥å¿—æ—¶æ³¨æ„åˆ°ï¼ŒELF åŠ è½½çš„ä¸€ä¸ªæ®µç»“æŸäº `0x1c128`ï¼Œä½†æ˜¯åœ¨å†…å­˜æ˜ å°„æ—¶ï¼Œ`MapArea::new`ä¼šå°†è¿™ä¸ªåŒºåŸŸæŒ‰é¡µå‘ä¸Šå¯¹é½ï¼Œæ‰€ä»¥ç»“æŸåœ°å€å˜æˆäº† `0x1d000`ï¼ˆå› ä¸ºé¡µå¤§å°ä¸º 4096 å­—èŠ‚ï¼Œ0x1c128 å‘ä¸Šå¯¹é½åˆ° `0x1d000`ï¼‰ã€‚

è¿™ä¸ªå¯¹é½æ“ä½œæ„å‘³ç€ï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ª ELF æ®µåˆ†é…çš„å†…å­˜åŒºåŸŸå®é™…ä¸Šè¦†ç›–äº† `0x18000` åˆ° `0x1d000`ï¼Œä½†æ˜¯ ELF æ–‡ä»¶æœ¬èº«åªå¡«å……åˆ° `0x1c128`ã€‚å› æ­¤ï¼Œä» `0x1c128` åˆ° `0x1d000` è¿™éƒ¨åˆ†å†…å­˜åŒºåŸŸæ˜¯æœªåˆå§‹åŒ–çš„ï¼Œé€šå¸¸è¿™éƒ¨åˆ†è¢«ç”¨ä½œ .bss æ®µï¼ˆåˆå§‹åŒ–ä¸º0ï¼‰ï¼Œæˆ–è€…ç”¨äºå¯¹é½ã€‚

```shell
[DEBUG] start_va 0x18000 end_va 0x1c128
[ INFO] (MemorySetInner, map_elf) ph_flags: Flags(6), map_perm: R | W | U
[DEBUG] MapArea::new(as virtaddr, aligned) start floor = 0x18000, end ceil = 0x1d000
```

0x1c128-0x1d000 å°±ä¼šå‡ºäºæœªåˆå§‹çŠ¶æ€

### 2025.7.21

åœ¨ `run_tasks()` é‡Œæ‰“å¼€ `/musl/busybox` å¯ä»¥æ‰“å¼€ä¹Ÿå¯ä»¥è¯»

åœ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹é‡Œå¯ä»¥æ­£å¸¸æ‰“å¼€ `/musl/busybox` å¹¶ `read_all` elfï¼Œä½†æ˜¯åœ¨è¿›ç¨‹åˆ‡æ¢åå°±ä¸å¯ä»¥ã€‚è€Œä¸”åœ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹é‡Œ `open` åï¼Œåœ¨è¿›ç¨‹åˆ‡æ¢åå°±å¯ä»¥æ­£å¸¸ `open`ï¼Œå½“æ—¶ä»ç„¶ä¸èƒ½ `read_all`ã€‚å¦‚æœä¸åœ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹é‡Œ `open`ï¼Œåœ¨è¿›ç¨‹åˆ‡æ¢å `open` å°±ä¼šå¤±è´¥. 

ç¿» virtio-drivers çš„ issue å‘ç°åœ¨ 24 å¹´æœ‰äººé‡åˆ°è¿‡ not ready çš„é—®é¢˜ï¼Œä¼¼ä¹æ˜¯æ²¡æœ‰åˆå§‹åŒ–å¯¼è‡´çš„. æˆ‘ä»¬ç”¨çš„ç‰ˆæœ¬æ¯”è¿™ä¸ªæ—§. æ‰“ç®—æ”¹æ”¹.

æ ¹æ® [The examples/riscv has a stuck bug Â· Issue #125](https://github.com/rcore-os/virtio-drivers/issues/125) æœ‰äººå’Œæˆ‘ä»¬é‡åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼Œäºæ˜¯æˆ‘ç”¨ 0.8.0 è€Œä¸æ˜¯æˆ‘ä»¬ç°æœ‰çš„ 0.6.0 é‡å†™äº†é©±åŠ¨ï¼Œå‘ç°ä»ç„¶æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œäºæ˜¯æˆ‘å‚ç…§ PR [Use atomic reads and writes for available and used ring. by qwandor Â· Pull Request #128](https://github.com/rcore-os/virtio-drivers/pull/128) åˆå¯¹æˆ‘ä»¬çš„å†…æ ¸è¿›è¡Œäº†æ”¹å†™ï¼Œä»ç„¶æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æœ‰ç‚¹è¿‡äºåº•å±‚ï¼Œä¸çŸ¥é“æ€ä¹ˆåŠäº†. 

åŸæ¥ 0.6.0 éƒ½ç®—ä½ï¼Œç”¨çš„ `61ece50` æ˜¯ 0.7.1. ä½†æ˜¯å¾€å¹´çš„å†…æ ¸ä½¿ç”¨çš„ç‰ˆæœ¬æ›´ä½.

å‚è€ƒäº† [ByteOS/driver/kvirtio/src/virtio_impl.rs at main Â· oscomp/ByteOS](https://github.com/oscomp/ByteOS/blob/main/driver/kvirtio/src/virtio_impl.rs) ä½†æ˜¯æ²¡ä»€ä¹ˆç”¨.

### 2025.7.22

æ²¡èƒ½è§£å†³é—®é¢˜.

### 2025.7.23

LA ä¸€ç›´åœ¨ `run_tasks` é‡Œ `context_switch` çš„å¾ªç¯ä¸­ï¼Œæœ¬æ¥åˆ‡æ¢è¿‡åå°±åº”è¯¥æ‰§è¡Œç”¨æˆ·æ€ç¨‹åºå¹¶è°ƒç”¨ syscallï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨è€Œæ˜¯è®¿é—®äº† ELF æ®µçš„æœ«å°¾åœ°å€. ç»“åˆç”¨æˆ·æ€ã€åœ°å€è®¿é—®å’Œ syscallï¼Œæƒ³åˆ°å¯èƒ½æ˜¯æˆ‘ä»¬å¿˜è®°äº†ä¿®æ”¹é“¾æ¥è„šæœ¬ï¼Œå› ä¸ºåŸæ¥æˆ‘ä»¬å‚è€ƒ rCoreloongArch æ˜¯ 16K é¡µè¡¨å¯¹é½çš„ï¼Œä½†æ˜¯ç°åœ¨å·²ç»éƒ½æ˜¯ 4K äº†. ä¿®æ”¹äº†é“¾æ¥è„šæœ¬çš„å¯¹é½ç„¶åå°±æˆåŠŸäº†ï¼

ä½†æ˜¯åœ¨ä¸­æ‰§è¡Œäº† `sys_fork` ååˆä¸€è½® syscall ä¼¼ä¹å‡ºç°äº† `InstructionNotExist` çš„é—®é¢˜ï¼š

```she
[DEBUG] (sys_fork) the new tid is :2
[ INFO] (suspend_current_and_run_next) suspending current task and running next task
[ INFO] TASK_MANAGER.ready_queue.len(): 1
[ INFO] task_cx_ptr: 0x900000008014c990
[ INFO] (trap_entry) into trap entry
[ INFO] (suspend_current_and_run_next) suspending current task and running next task
[ INFO] TASK_MANAGER.ready_queue.len(): 1
[ INFO] task_cx_ptr: 0x900000008014dd90
[kernel] Panicked at libs/polyhal/polyhal-trap/src/trap/loongarch64.rs:231 Unhandled trap Exception(InstructionNotExist) @ 0x107f4 BADV: 0x107f4:
```

ä½¿ç”¨åæ±‡ç¼–å¯ä»¥çœ‹å‡ºæ˜¯åœ¨ `sys_fstatat` è¿™ä¸ªè°ƒç”¨ä¸­ï¼š

```assembly
9000000080010b60:	50008000 	b           	128(0x80)	# 9000000080010be0 <_ZN2os7syscall2fs11sys_fstatat17h35beec7dd6206650E+0x2e0>
9000000080010b64:	00150305 	move        	$a1, $s1
9000000080010b68:	001400a4 	nor         	$a0, $a1, $zero
9000000080010b6c:	0010f884 	add.d       	$a0, $a0, $s7
9000000080010b70:	00109725 	add.d       	$a1, $s2, $a1
```

ä½†æ˜¯ä¸çŸ¥é“è¯¥æ€ä¹ˆä¿®æ”¹.

### 2025.7.24

æ²¡ä»€ä¹ˆè¿›å±•.

ä¸€å®šæ˜¯æˆ‘ä»¬æ‰€åšçš„å“ªä¸€æ­¥æœ‰é—®é¢˜ï¼Œå¯¼è‡´ `satp` å§‹ç»ˆæ— æ³•åˆ‡æ¢ï¼Œå¦‚æœåˆ‡æ¢å°±ä¼šå¡æ­»ï¼Œå¦‚æœä¸åˆ‡æ¢å°±ä¼šå½±å“ä¹‹åçš„æ ˆæŒ‡é’ˆç„¶åä¾ç„¶æ˜¯æ­»å¾ªç¯ï¼Œå¡åœ¨ `sys_execve`.

### 2025.7.25

è€ƒè™‘è¦ä¸è¦åˆ é™¤ `polyhal`ï¼Œæˆ‘ä»¬æ€€ç–‘ä»–çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å­˜åœ¨é—®é¢˜. ä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éƒ½æ²¡ä»€ä¹ˆç²¾åŠ›å†åšä¸€ä¸ªå·¨å¤§çš„æ”¹åŠ¨äº†. å¦‚æœç”¨é‡æ„ä¹‹å‰çš„å…¶å®ä¹Ÿç›¸å½“éš¾åŠï¼Œæˆ‘ä»¬å¥½ä¸å®¹æ˜“æ‰åˆ é™¤äº†å„ç§ä¹±ä¸ƒå…«ç³Ÿçš„æ¡ä»¶ç¼–è¯‘ç»Ÿä¸€äº†æ¶æ„å·®å¼‚.

å¦‚æœèƒ½å‘ç° `polyhal` çš„é”™è¯¯å½“ç„¶æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ‰¾äº†ä¸€å‘¨è¿˜æ˜¯æ²¡æ˜ç™½.

è‡³å°‘åœ¨æˆ‘çš„æœ¬åœ°ä¸‹æœ‰è¿™ä¹ˆä¸¤ä¸ªé—®é¢˜ï¼š
- la ä¼šæŠ¥é”™ `InstNotExist`
- rv ä¸‹ä¼šæ— æ³•å†™å…¥ `satp` å¯¼è‡´åç»­çš„åœ°å€ç©ºé—´éƒ½å‡ºç°é—®é¢˜.

gdb è°ƒè¯•äº†ä¸€ä¸‹ï¼Œ`info registers csr` æ˜¾ç¤º `priv` æ˜¯ 1ï¼Œä¹Ÿå°±æ˜¯ Supervisor.

æœ€åå®é™…ä¸Šå¡åœ¨äº†è¿™ä¸ªå‡½æ•°

```rust
#[naked]
pub unsafe extern "C" fn kernelvec() {
    naked_asm!(
        includes_trap_macros!(),
        // å®å®šä¹‰
        r"
            .align 4
            .altmacro
        
            csrrw   sp, sscratch, sp
            bnez    sp, uservec
            csrr    sp, sscratch

            addi    sp, sp, -{cx_size}
            
            SAVE_GENERAL_REGS
            csrw    sscratch, x0

            mv      a0, sp

            call kernel_callback

            LOAD_GENERAL_REGS
            sret
        ",
        cx_size = const crate::trapframe::TRAPFRAME_SIZE,
    )
}
```

è€ƒè™‘ä¼šä¸ä¼šæ˜¯é¡µå¯¹é½çš„é—®é¢˜ï¼ŸåŠ ä¸Šäº† `assert!`. ä½†æ˜¯ä¹Ÿé¡ºåˆ©é€šè¿‡äº†.

```rust
#[inline]
pub fn change(&self) {
    // Write page table entry for
    assert!(self.0.raw() & 0xfff == 0, "Page table address must be aligned to 4K");
    unsafe { satp::write(Satp::from_bits((8 << 60) | (self.0.raw() >> 12))) }
    TLB::flush_all();
}
```

ä¼¼ä¹æ˜¯åº•å±‚é™·å…¥äº† Trapï¼Œ`ph_ctor!(TRAP_INIT, CtorType::Cpu, init);` æœ‰ç‚¹å¤ªè¶…å‡ºæˆ‘ä»¬çš„èƒ½åŠ›èŒƒå›´äº†. ä¸€èˆ¬æ¥è¯´ `polyhal` å‘å¸ƒä¹‹å‰éƒ½æ˜¯ç»è¿‡æµ‹è¯•çš„ï¼Œè‚¯å®šå¯ä»¥é€šè¿‡æ‰å¯¹.

> 2025.8.15ï¼šå¯èƒ½æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„å·¥å…·é“¾ç‰ˆæœ¬æˆ–è€…æ•´ä½“è®¾è®¡å­˜åœ¨é—®é¢˜ï¼Œåœ¨åç»­é‡åˆ°äº†ç±»ä¼¼çš„ `InstNotExist` é”™è¯¯ï¼Œåœ¨åˆ†é¡µæ¨¡å¼ä¸‹è¿™ä¸ªé”™è¯¯å°±æ˜¯ `FetchPageFault`.

åŸºäºåˆèµ›ç»“æŸæ—¶çš„åˆ†æ”¯é‡æ„.

å› ä¸ºæœ‰äº†ä¹‹å‰ä¸€ä¸ªæœˆçš„ç»éªŒï¼Œç°åœ¨å†ä»åˆèµ›å‰çš„åˆ†æ”¯å¼€å§‹é‡æ„è¿˜ç®—è½»æ¾ï¼Œå¾ˆå¿«å°±åšäº†é«˜åœ°å€å¯åŠ¨å’Œå…¶ä»–çš„ä¸€äº›å…¼å®¹å·¥ä½œ.

é‡æ„ `heap_allocator`ï¼Œå‚è€ƒ [åŠ¨æ€å†…å­˜åˆ†é…å™¨å®ç°-ä»¥buddy_system_allocatoræºç ä¸ºä¾‹](https://www.cnblogs.com/chenhan-winddevil/p/18447537).

### 2025.7.26

å…ˆå‰æˆ‘ä»¬ä½¿ç”¨ `polyhal` ç›´æ¥å¯åŠ¨äº†é«˜ä½åœ°å€ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°å®ƒ.

ä¿®æ”¹å…³äº `KERNEL_SPACE` çš„æ˜ å°„. `frame_alloctor` çš„èµ·å§‹åœ°å€å°±æ˜¯é«˜ä½åœ°å€ï¼Œåœ¨ `get_bytes_array` æ—¶è¿˜ä¼šå†è¿›è¡Œä¸€æ¬¡å¯¹é«˜ä½åœ°å€çš„è½¬åŒ–ï¼Œè¿™æ ·ç›¸å½“äºå°†ä¸€ä¸ªé«˜åœ°å€è½¬æ¢ä¸ºä¸€ä¸ªé«˜åœ°å€ï¼Œå¾ˆå¥‡æ€ª. ä»–ä»¬çš„ `MEMORY_END` ä¹Ÿæ˜¯åŠ ä¸Šäº†é«˜åœ°å€åç§»é‡çš„ï¼Œä½†æ˜¯ä»–ä»¬ç«Ÿç„¶å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Ÿ

å› ä¸ºåœ¨æ–°å»ºä¸€ä¸ª `frame_allocator` æ˜¯å°†ç‰©ç†åœ°å€è¿›è¡Œå¤„ç†ï¼Œè€Œåœ¨ `KERNEL_SPACE` æ—¶æ˜¯å°†é«˜ä½åœ°å€æ’ç­‰æ˜ å°„.

ä¸Šä¸‹æ–‡æ— æ³•åˆ‡æ¢. åº”è¯¥æ˜¯å› ä¸ºæˆ‘ä¹‹å‰å–æ¶ˆäº†è·³è¡¨é¡µçš„æ˜ å°„ï¼Œä¸è¿‡æˆ‘æ¢å¤äº†è·³è¡¨é¡µæ˜ å°„è¿‡åä»ç„¶è¿˜æ²¡æœ‰è§£å†³é—®é¢˜.

å‘ç°åœ¨åˆ‡æ¢è‡³ç”¨æˆ·æ€åæ— æ³•å›åˆ°å†…æ ¸æ€.

### 2025.7.27

ç ”ç©¶ä¸€ä¸‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæˆ‘æ€€ç–‘æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢æœ‰é—®é¢˜.

å‚è€ƒ [RISC-Vé€šç”¨å¯„å­˜å™¨åŠå‡½æ•°è°ƒç”¨è§„èŒƒ | Half Coder](https://lgl88911.github.io/2021/02/15/RISC-Vé€šç”¨å¯„å­˜å™¨åŠå‡½æ•°è°ƒç”¨è§„èŒƒ/)ï¼Œä½¿ç”¨äº†[è·³æ¿é¡µ](https://learningos.cn/rCore-Camp-Guide-2025S/chapter4/6multitasking-based-on-as.html#term-trampoline)ä¹Ÿå°±æ˜¯å…¨éš”ç¦»å†…æ ¸ï¼Œåˆ™ `__alltrap` å°±éœ€è¦åœ¨ä¿å­˜ä¸Šä¸‹æ–‡ä¹‹å‰å›åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼Œè€Œ `__restore` ä¹Ÿéœ€è¦åœ¨å›å¤ä¸Šä¸‹æ–‡ä¹‹å‰å›åˆ°åº”ç”¨åœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¦å›åˆ°ä»–ä»¬å¯¹åº”çš„åœ°å€ç©ºé—´è®¿é—®å¯¹åº”çš„æ•°æ®. è¿™å°±æ¶‰åŠäº† `satp` çš„åˆ‡æ¢.

```rust
#[inline]
fn set_user_trap_entry() {
    unsafe {
        stvec::write(TRAMPOLINE as usize, TrapMode::Direct);
    }
}
```

è¿™å®é™…ä¸Šæ˜¯é€šè¿‡å†™å…¥ `TRAMPOLINE` æ¥è®©å…¶è·³è½¬è‡³ `__alltrap` çš„æ±‡ç¼–ä»£ç .

ä¸èƒ½ç›´æ¥ `call __alltraps` æ˜¯å› ä¸ºè·³è½¬æŒ‡ä»¤å®é™…ä¸Šæ˜¯æ ¹æ®åç§»é‡æ¥æ‰§è¡Œçš„ï¼Œä½†æ˜¯ç»è¿‡åœ°å€æ˜ å°„ä¸èƒ½ç›´æ¥å¯¹å…¶ç›¸åŠ .

```rust
let restore_va = __restore as usize - __alltraps as usize + TRAMPOLINE;
```

è¿™æ˜¯åœ¨ `TRAMPOLINE` çš„åŸºç¡€ä¸ŠåŠ ä¸Š `__restore` ç›¸å¯¹ `__alltraps` çš„åç§»é‡ï¼Œå®ç°å¯¹ `__restore` åœ°å€çš„è®¿é—®.

æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å¼€å¯äº†é«˜åœ°å€åï¼Œé“¾æ¥è„šæœ¬çš„å†…å®¹ä¹Ÿå…¨éƒ½æ˜¯è™šæ‹Ÿåœ°å€äº†ï¼Œæ‰€ä»¥ `map_trampoline` æ— æ³•æ­£ç¡®è®¿é—®ç‰©ç†åœ°å€ï¼Œä»è€Œå¯¼è‡´æ— æ³•å›åˆ° `__alltraps` è¿›è¡Œæ‰§è¡Œï¼Œæ„Ÿè°¢é˜Ÿå‹ç»™æˆ‘çš„çµæ„Ÿï¼ŒçœŸæ˜¯å¤ªé è°±äº†ï¼

è¿˜ä¿®æ”¹äº† `get_ref` é”™è¯¯çš„åœ°å€è½¬æ¢é—®é¢˜ï¼Œç°åœ¨éœ€è¦å°†ä¼ å…¥çš„ç‰©ç†åœ°å€åŠ ä¸Šåç§»é‡ä¹‹åå†è·å–.

åˆå‡ºç°äº† NotReady çš„é—®é¢˜. æ•´å¥—å·¥å…·é“¾ä¼¼ä¹æœ‰ç‚¹ä¸ç¨³å®šï¼Œå¦‚æœç‰¹åˆ¤ NotReady çš„æŠ¥é”™ä¼šåœ¨åº”è¯¥å‘ç”Ÿè¿™ä¸ªé”™è¯¯ä¹‹å‰å°±å¡æ­»åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢çš„éƒ¨åˆ†. è€Œå¦‚æœæˆ‘åœ¨ vendor é‡Œæ·»åŠ  `info!` ç”šè‡³å°±ä¼šå¯¼è‡´è¿›ç¨‹åœ¨åˆ‡æ¢å›ç”¨æˆ·æ€åæ— æ³•åˆ‡å›å†…æ ¸æ€ï¼Ÿè¿™ä¸ªé—®é¢˜æœ‰ç‚¹[è«åå…¶å¦™](https://sazikk.top/posts/å¼€å‘æ—¥å¿—-chaoså¼€å‘æ—¥å¿—/#è™šæ‹Ÿå—è®¾å¤‡é©±åŠ¨è¯»å–ç¬¬ä¸€ä¸ªè™šæ‹Ÿå—æ—¶è¯»å–å¤±è´¥)ï¼Œç‰¹åˆ¤å¯èƒ½ä¼šç•™ä¸‹å…¶ä»–éšæ‚£è€Œä¸”æˆ‘ä»¬å°è¯•è¿‡åå‘ç°å¹¶ä¸èƒ½è§£å†³é—®é¢˜.

### 2025.7.28

å’Œé˜Ÿå‹è®¨è®ºäº†ä¸€ä¸‹ï¼Œé«˜ä½åœ°å€å®é™…ä¸Šåªæ˜¯æ‹“å±•äº†è™šæ‹Ÿåœ°å€çš„èŒƒå›´. è™½ç„¶ RISCV çš„é«˜åœ°å€è®¾ç½®å¯¹ LoongArch çš„å…¼å®¹æœ‰å¸®åŠ©ï¼Œå¯ä»¥å®ç°æ›´å¤šæ¥å£ä¸Šçš„ç»Ÿä¸€ï¼Œä½†æ˜¯é©±åŠ¨å±‚çš„ NotReady é—®é¢˜æˆ‘ä»¬è¿˜æ˜¯å¯¹æ­¤æŒæœ‰ç–‘è™‘ï¼Œåœ¨ä¹‹å‰æˆ‘ä»¬é€‚é… polyhal çš„æ—¶å€™ä¹Ÿæ˜¯ä»¥ RISCV çš„é«˜åœ°å€å¯åŠ¨ï¼ŒåŒæ ·é‡åˆ°äº† NotReady çš„é—®é¢˜ï¼Œä¸ºäº†å†…æ ¸çš„ç¨³å®šæ€§æˆ‘ä»¬æ‰“ç®—è¿˜æ˜¯å›åˆ° RISCV çš„ä½åœ°å€å¯åŠ¨æ–¹å¼.

å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `os.bin` è¿è¡Œ glibc çš„ busybox å°±ä¼šè§¦å‘ StorePageFaultï¼Œä½†æ˜¯ä»¥ ELF æ–‡ä»¶å¯åŠ¨å†…æ ¸å°±ä¸ä¼šï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šè¡¨ç°å‡ºè¿™æ ·çš„å·®å¼‚. å…ˆå‰èƒ½æˆåŠŸå¤šå°‘æœ‰ç‚¹è¿æ°”æˆåˆ†åœ¨.

ç„¶åæ˜¯å®ç° LoongArch çš„å…¼å®¹ï¼Œ[Fediory/NPUcore-IMPACT](https://github.com/Fediory/NPUcore-IMPACT/tree/NPUcore-FF) å¯ä»¥ç»™å‡ºä¸€äº›å‚è€ƒ.

LoongArch [å¯åŠ¨](https://godones.github.io/rCoreloongArch/boot.html#uefibios)çš„æ—¶å€™ä¼šå°† `0x8000_xxxx_xxxx_xxxx` å’Œ `0x9000_xxxx_xxxx_xxxx` çš„åœ°å€é€šè¿‡ç›´æ¥æ˜ å°„çª—å£æ˜ å°„åˆ°ä½ä½çš„ç‰©ç†åœ°å€.

```assembly
ori         $t0, $zero, 0x1     # CSR_DMW1_PLV0
lu52i.d     $t0, $t0, -2048     # UC, PLV0, 0x8000 xxxx xxxx xxxx
csrwr       $t0, 0x180          # WRITE TO LA DMWIN0 CSR
ori         $t0, $zero, 0x11    # CSR_DMW1_MAT | CSR_DMW1_PLV0
lu52i.d     $t0, $t0, -1792     # CA, PLV0, 0x9000 xxxx xxxx xxxx
csrwr       $t0, 0x181          # WRITE TO LA DMWIN1 CSR
```

è¿™æ ·å°±è®© `0x9000_xxxx_xxxx_xxxx` å¼€å¤´çš„è¯¸å¦‚ `stext` å’Œ `srodata` å„æ®µè¢«ç›´æ¥æ˜ å°„äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ä¸ç”¨åƒ RISCV å†…æ ¸é‚£æ ·å®ç° `KERNEL_SPACE` æ¥æ‰‹åŠ¨æ˜ å°„.

NPUcore-IMPACT ä½¿ç”¨äº† `KERNEL_SPACE`ï¼Œçœ‹èµ·æ¥å’Œ rCore åˆ«æ— äºŒè‡´. æ—¢ç„¶ LA æœ‰äº†ç›´æ¥æ˜ å°„çª—å£æˆ‘è¿˜æ˜¯é‡‡ç”¨ä¸€å¤è¿™ä¸ªç‰¹æ€§ï¼Œæ‰€ä»¥åœ¨æ¥å£å®ç°ä¸Šä¼šå±•ç°ä¸€äº›æ¶æ„å·®å¼‚ï¼Œä»¥åå¦‚æœæœ‰éœ€è¦å†ä¸º LA é‡æ„ `KERNEL_SPACE`.

ç„¶åæ˜¯ç»Ÿä¸€é¡µè¡¨ç¿»è¯‘çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯ç»Ÿä¸€ä¸º 4KB çš„é¡µå¤§å°è€Œä¸æ˜¯ 16 KB.

LA å¯„å­˜å™¨å¤§å­¦ä¹ ï¼Œå› ä¸ºç›¸æ¯” RV æ¥è¯´ LA çš„å¯„å­˜å™¨éœ€è¦æ›´å¤šçš„æ‰‹åŠ¨è®¾ç½®. ä½¿ç”¨è¿™ä¸ªåº“ [loongArch64 - Rust](https://docs.rs/loongArch64/0.2.4/loongArch64/index.html).

æ¶‰åŠä¸­æ–­çš„ `ticlr`, `tcfg`, `ecfg` å’Œ `crmd` æ²¡ä»€ä¹ˆç‰¹åˆ«éœ€è¦ä¿®æ”¹çš„åœ°æ–¹. `eentry` å­˜æ”¾ç€å…³äºä¸Šä¸‹æ–‡åˆ‡æ¢çš„ç¬¦å·åœ°å€ `__kernel_trap_entry`. `tlbentry` æ”¾ç€ TLB é‡å¡«çš„ç¬¦å·åœ°å€ `__tlb_rfill`.

`stlbps` å’Œ `tlbrehi` éœ€è¦ä¿®æ”¹ä»–ä»¬çš„é¡µé¢å¤§å°.

### 2025.7.29

ç»§ç»­ç»Ÿä¸€é¡µé¢å¤§å°ï¼Œä¿®æ”¹ rCoreloongArch åŸæœ¬çš„ 16 KiB å¤§å°é¡µä¸ºä¸ RISCV æ¶æ„ä¸‹ç›¸åŒçš„ 4 KiB.

`pwcl` å¯„å­˜å™¨çš„ `PTwidth` å­—æ®µæ˜¯æœ«çº§é¡µè¡¨çš„ç´¢å¼•ä½æ•°ï¼Œé€šè¿‡è®¡ç®—å¯ä»¥å¾—çŸ¥ï¼Œåœ¨ `PALEN` å’Œ `VALEN` éƒ½ä¸º 48 çš„æƒ…å†µä¸‹ï¼Œä¸‰çº§é¡µè¡¨ç´¢å¼•çš„ä½æ•°ä¸º 9ï¼Œé¡µçš„åç§»å­—æ®µä½æ•°ä¸º 12ï¼Œç›¸å‡å¯å¾— `PWwidth` ä¸º 9. ä½†è¿™æ ·è®¡ç®—å…¶å®æ˜¯æ¼æ‰äº† `PGD` å®ƒå æœ‰çš„ä¸€ä½ï¼Œå¦‚æœä½¿ç”¨ä¸‰çº§é¡µè¡¨é‚£è¡¨å®½åº¦å°±ä¸ä¸€è‡´äº†. è¿™å¯¹å—ï¼Ÿ

ä¸‹å›¾æ˜¯ä½¿ç”¨ 16 KiB é¡µè¡¨çš„æ¨¡å¼.

<img src="https://godones.github.io/rCoreloongArch/sourcepicture/image-20220814165043640.png" style="zoom:80%;" />

å‚è€ƒä¸€ä¸‹ [Fediory/NPUcore-IMPACT](https://github.com/Fediory/NPUcore-IMPACT/tree/NPUcore-FF) ä¿®æ”¹å¯„å­˜å™¨ï¼Œä»–ä»¬é‚£æ—¶ LoongArch çš„ crate è¿˜ä¸åƒä»Šå¤©è¿™ä¹ˆå®Œå–„ï¼Œæ‰€æœ‰å¯„å­˜å™¨éƒ½æ˜¯æ‰‹åŠ¨æ“ä½œ. ä»–ä»¬å¯¹ `pwcl` å’Œ `pwch` çš„è®¾ç½®æ˜¯ï¼š

```rust
// os/src/arch/la64/mod.rs
PWCL::read()
    .set_ptbase(PAGE_SIZE_BITS)
    .set_ptwidth(DIR_WIDTH)
    .set_dir1_base(PAGE_SIZE_BITS + DIR_WIDTH)
    .set_dir1_width(DIR_WIDTH) // 512*512*4096 should be enough for 256MiB of 2k1000.
    .set_dir2_base(0)
    .set_dir2_width(0)
    .set_pte_width(PTE_WIDTH)
	.write();
PWCH::read()
    .set_dir3_base(PAGE_SIZE_BITS + DIR_WIDTH * 2)
    .set_dir3_width(DIR_WIDTH)
    .set_dir4_base(0)
    .set_dir4_width(0)
    .write();
```

é‚£å…¶å®è¯´æ˜ LoongArch å®Œå…¨æ˜¯å¯ä»¥å®ç° 4 KiB é¡µçš„.

æˆ‘ä»¬å®é™…ä¸Šä¹Ÿæœ‰ `pgd` çš„æ“ä½œï¼š

```rust
// è®¾ç½®æ–°çš„pgdl
let pgd = new_token << PAGE_SIZE_BITS;
// Pgdl::read().set_val(pgd).write(); //è®¾ç½®æ–°çš„é¡µåŸºå€
pgdl::set_base(pgd); //è®¾ç½®æ–°çš„é¡µåŸºå€
```

`pgd` å¹¶éåªæœ‰ä¸€ä¸ªä½ï¼Œå®é™…ä¸Šè¿™ä¸ªæœ€é«˜ä½å†³å®šçš„æ˜¯ `pgd` æ¥è‡ª `pgdl` è¿˜æ˜¯ `pgdh`. å…·ä½“å¯è§äºé¾™èŠ¯çš„æ¶æ„æ‰‹å†Œ 5.4.5 éƒ¨åˆ†. æ—¢ç„¶å¦‚æ­¤é‚£å°±ä¸å¿…å°† 47 ä½éƒ½å¡«æ»¡ï¼Œè€Œä¸”åŸæœ¬å°±æ²¡æœ‰ `set_dir4_base(47)` è¿™ç§æ“ä½œ.

RISCV ä¸­çš„ `from_token` ç”¨ `PhysPageNum::from(satp & ((1usize << 44) - 1)` æ˜¯å› ä¸º `satp` æœ¬èº«å­˜çš„å°±æ˜¯ 44 ä½çš„ç‰©ç†é¡µå·. rCoreloongArch ä½¿ç”¨ `PhysPageNum::from(pgd & ((1usize << 34) - 1))` ç€å®éå¸¸ç–‘æƒ‘ï¼Œåœ¨æ–‡æ¡£é‡Œä¹Ÿä¸å¸¦ä»»ä½•è§£é‡Šï¼Œè¿™ä¸ªæ“ä½œæœ¬èº«ç›¸å½“äºå– `pgd` çš„ä½ 34 ä½ï¼Œä½†è¯è¯´å›æ¥åªè¦çŸ¥é“å®ƒå­˜çš„æ˜¯ç‰©ç†é¡µå·å°±å¯ä»¥ï¼Œæ‰€ä»¥æˆ‘æš‚ä¸”å…ˆç…§æ—§ä¿ç•™.

ä¿®æ”¹è¿‡ååœ¨å»ºç«‹è¿›ç¨‹çš„ç”¨æˆ·æ ˆæ˜ å°„æ—¶å‡ºç°äº†æŠ¥é”™

```shell
[kernel] Panicked at src/hal/trap/mod.rs:466 [pc:0x0], cause:Exception(FetchPageFault),  code:100000000000
```

é€šè¿‡æ—¥å¿—

```shell
[ INFO] in alloc_user_res, ustack_bottom: 0x4f448000, ustack_top: 0x4f450000
[DEBUG] MapArea::new start floor = 0x4f448, end ceil = 0x4f450
[DEBUG] in vpn range new
[DEBUG] in mem set push
[DEBUG] in map area map
[DEBUG] in map one
[ WARN] in map area, map one, the ppn is : 8969
[ INFO] in page table map, find pte create ok, ppn: 0x2309, flags: (empty)
[ INFO] in map area, map one, vpn: 0x0, ppn: 0x2309, flags: (empty)
[kernel] Panicked at src/hal/trap/mod.rs:466 [pc:0x0], cause:Exception(FetchPageFault),  code:100000000000
```

åœ¨ `map_one` ä¸­ï¼Œç»è¿‡ `frame = frame_alloc().unwarp()` ä¹‹å `vpn` å°±ä¼šå˜ä¸º 0.

```rust
#[cfg(target_arch = "loongarch64")]
{
    info!("(MapArea, map_one) vpn: {:#x}", vpn.0);
    let frame = frame_alloc().unwrap();
    info!("(MapArea, map_one) vpn: {:#x}", vpn.0);
    ppn = frame.ppn;
    info!("(MapArea, map_one) vpn: {:#x}, ppn: {:#x}", vpn.0, ppn.0);
    self.data_frames.insert(vpn, Arc::new(frame)); //è™šæ‹Ÿé¡µå·ä¸ç‰©ç†é¡µå¸§çš„å¯¹åº”å…³ç³»
}
info!("(MapArea, map_one) vpn: {:#x}, ppn: {:#x}", vpn.0, ppn.0);
```

```shell
[DEBUG] in map area map
[DEBUG] (MapArea, map_one) vpn: 0x4f448
[ INFO] (MapArea, map_one) vpn: 0x4f448
[ INFO] (MapArea, map_one) vpn: 0x0
[ INFO] (MapArea, map_one) vpn: 0x0, ppn: 0x2309
[ INFO] (MapArea, map_one) vpn: 0x0, ppn: 0x2309
[ INFO] in page table map, find pte create ok, ppn: 0x2309, flags: (empty)
[ INFO] (MapArea, map_one) vpn: 0x0, ppn: 0x2309, flags: (empty)
[kernel] Panicked at src/hal/trap/mod.rs:466 [pc:0x0], cause:Exception(FetchPageFault),  code:100000000000
```

åŸå› æ˜¯åœ¨ `alloc_user_res` é‡Œæ²¡æœ‰ç»™ LA æ·»åŠ åœ°å€æ˜ å°„.

### 2025.7.30

```shell
[DEBUG] kernel: TaskManager::fetch_task
[ WARN] in run_tasks, task tid: 0
[ INFO] badv: 0x10b94
[ WARN] in run_tasks, next task cx ptr: 0x90000000820eca40, idle task cx ptr: 0x90000000820cf0e0
[ WARN] in run_tasks, to switch, current ra is : 0x900000008205b500,current sp is :0x9000000084110d48, next ra is :0x9000000082030060, next sp is : 0x90000000820cecb0
[ INFO] badv: 0x10b94
[ INFO] badv: 0x5
[ INFO] [kernel] trap_handler: Exception(LoadPageFault) at 0x5 as virtadd
[ INFO] [kernel] trap_handler: Exception(LoadPageFault) at 0x0 as vpn
[ INFO] cow_page_fault: vpn = 0x0
[ INFO] cow_page_fault: scause = Exception(LoadPageFault)
[kernel] Exception(LoadPageFault) 0x5 in application, core dumped.
[kernel] Segmentation Fault, SIGSEGV=11
```

åˆ‡æ¢è‡³**ç”¨æˆ·æ€**åå‘ç”Ÿé”™è¯¯. ä¼šæ˜¯ `task_cx` é€ æˆçš„å—ï¼Ÿä¸Šä¸‹æ–‡åˆ‡æ¢è¿™é‡Œæˆ‘ä»¬åœ¨ä¸åŒæ¶æ„ä¸Šä½¿ç”¨äº†ä¸åŒçš„å®ç°.

åœ¨ RISCV ä¸‹æ˜¯é€šè¿‡åœ¨ `KERNEL_SPACE` é‡Œå»ºç«‹å†…æ ¸æ ˆæ˜ å°„æ ¹æ® `kstack_id` å’Œ `TRAMPOLINE` çš„ç›¸å¯¹ä½ç§»æ¥ç´¢å¼• `task_cx`. åŸæœ¬çš„ rCoreloongArch æ˜¯é€šè¿‡åˆ†é…è€Œå¾—çš„ç‰©ç†é¡µå¸§åŠ ä¸Š `VIRT_BIAS` å¾—åˆ°é«˜ä½åœ°å€å¹¶å°†å…¶ä¿å­˜ä¸‹æ¥å®ç°çš„.

```shell
[DEBUG] initialize cache! /musl/basic_testcode.sh
[DEBUG] in read ,to return, the ret is :154
[DEBUG] kernel: TaskManager::fetch_task
[ INFO] idle task cx ptr: 0x90000000840ce300, next task cx ptr: 0x90000000840c1b40
[ INFO] ##### syscall with id 135 #####
[DEBUG] in sys sig proc mask
[ INFO] ##### syscall with id 135 #####
[DEBUG] in sys sig proc mask
[ INFO] ##### syscall with id 220 #####
[DEBUG] (sys_fork) flags: 17, stack_ptr: 0x0, parent_tid_ptr: 0x4f44f720, tls_ptr: 0x8, child_tid_ptr: 0x0
[ INFO] (sys_fork) current process pid is : 1, flags: SIGCHLD
[DEBUG] (MemorySetInner, push)
[DEBUG] (MapArea, map) mapping area
[ INFO] MapArea::map_one: vpn = 0x120000, ppn = 0x840f5, pte_flags = PLVL | PLVH, cow = true
[kernel] Panicked at src/hal/trap/mod.rs:467 [pc:0x0], cause:Exception(FetchPageFault),  code:0
```

å–ä¸åˆ° `PageTableEntry`.

æ‰“ç®—å°è¯•ä¸€ä¸‹ä¸º LoongArch æ·»åŠ è·³æ¿é¡µï¼Œè¿™æ ·å¯ä»¥å¤§å¤§é™ä½ä¸åŒæ¶æ„ä¹‹é—´çš„å·®å¼‚æ€§ï¼Œæ›´å®¹æ˜“äºç»´æŠ¤ï¼Œä¿®åœ°å€æ˜ å°„é—®é¢˜è¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦.

`MapPermission` å’Œ `PTEFlags` ç”±äºä¸¤ä¸ªæ¶æ„çš„å·®å¼‚æƒ³ç”¨èµ·æ¥ä¹Ÿå¾ˆè¯¡å¼‚ï¼Œå¾—å†™ä¸€å¤§å †æ¡ä»¶ç¼–è¯‘ï¼Œæˆ‘æ‰“ç®—å…ˆç”¨ç±»ä¼¼ polyhal çš„æ–¹æ³•å°†ä»–ä»¬ç»Ÿä¸€ä¸€ä¸‹ï¼Œç„¶åå†å®ç°è·³æ¿é¡µ. å¸Œæœ›åœ¨ 8 æœˆå‰å¯ä»¥ç»“æŸè¿™ä¸¤ä¸ªå·¥ä½œ. è™½ç„¶æˆ‘ç”¨ polyhal ç”¨å¾—æ¯”è¾ƒå¤±è´¥ï¼Œä½†æ˜¯ä»–çš„æ¥å£ç¡®å®å¤„ç†å¾—å¾ˆå¥½.

### 2025.7.31

LA çš„è·³æ¿é¡µå®ç°ä¼¼ä¹å¹¶ä¸éœ€è¦ `kernel_satp` çš„æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡ `invtlb 0x3, $zero, $zero` å®ç°çš„. ä¸è¿‡ä»–ä»¬çš„ `__restore` æœ‰ `slli.d $a1, $a1, 12` å’Œ `csrwr $a1, CSR_PGDL` æ¥æ¢å¤è‡³ç”¨æˆ·ç©ºé—´. å…¼å®¹æ€§è€ƒè™‘æˆ‘éƒ½ä¿ç•™ç€. RISCV è¿˜éœ€è¦ä¸€ä¸ªä¸“é—¨çš„ `sepc` åœ¨ LoongArch ä¸‹å¯¹åº” `pc`. 

NPUCore å°† `pc` è®¾ä¸ºé€šç”¨å¯„å­˜å™¨çš„ç¬¬ä¸€ä¸ªæˆå‘˜. ä½†ä¸€èˆ¬æ¥è¯´ LoongArch ä¹Ÿä¸è®¤ä¸º `pc` ä¹Ÿå°±æ˜¯ `$r0` æ˜¯[é€šç”¨å¯„å­˜å™¨](https://www.kernel.org/doc/html/v6.1/translations/zh_CN/loongarch/introduction.html#id2)ä¹‹ä¸€å§. æ ¹æ® LoongArch æ‰‹å†Œ 2.1.2 å¯„å­˜å™¨ä¸€èŠ‚ï¼ŒGR å’Œ PC æ˜¯åŸºç¡€æ•´æ•°æŒ‡ä»¤æ‰€æ¶‰åŠçš„ä¸åŒå¯„å­˜å™¨. åªèƒ½è¯´ NPUCore æ¯”è¾ƒæŠ½è±¡. ä¸è¿‡æ ¹æ® LoongArch æ‰‹å†Œ 3.1.3.2 èŠ‚ï¼Œæœ‰ä¸€ä¸ª `fcc` çš„å¯„å­˜å™¨æœºåˆ¶ï¼Œè¿™é‡Œæ˜¯ä¸ RISCV çš„å·®åˆ«ï¼Œ`FloatRegs` è¿˜æ˜¯ä¸èƒ½å®Œå…¨ä¸€è‡´çš„. NPUCore çœ‹èµ·æ¥å°±æ˜¯ rCore çš„ LoongArch ç‰ˆæœ¬æ”¹å†™.

å®ç°äº† RISCV çš„æµ®ç‚¹å¯„å­˜å™¨å’Œ `original_a0` çš„ä¿å­˜.

åŸæœ¬ LoongArch çš„ `trap.s` æ˜¯å°† `$sp` ä¿å­˜åœ¨ `0x502` è¿™ä¸ªä¸­ä»‹ä¸Šï¼Œ`0x502` æ˜¯ä¿å­˜è°ƒè¯•æ•°æ®çš„åœ°å€. æ­¤å¤„æˆ‘å‚è€ƒ NPUCore å°† `$sp` ä¿å­˜åœ¨ `0x30` è¿™ä¸ªæ•°æ®ä¿å­˜çš„å¯„å­˜å™¨ä¸Šï¼Œå…³äºå¯„å­˜å™¨çš„ä¿¡æ¯éƒ½å¯ä»¥åœ¨ LoongArch æ‰‹å†Œçš„ 7.1 èŠ‚æ‰¾åˆ°.

## å…«æœˆ

### 2025.8.1

ä¿®æ”¹è¿‡åçš„ LoongArch æ¶æ„ä¼šæŠ¥é”™

```she
Interrupt enable: LineBasedInterrupt(HWI0 | TIMER)
/**** APPS ****
[ INFO] mmconfig_base = 0x20000000
[DEBUG] Enumerating PCI devices...
[DEBUG] alloc_pci: size = 0x1000
[DEBUG] alloc_pci: size = 0x4000
[DEBUG] Device features: BlkFeature(SEG_MAX | GEOMETRY | BLK_SIZE | FLUSH | TOPOLOGY | CONFIG_WCE | DISCARD | WRITE_ZEROES | RING_INDIRECT_DESC | RING_EVENT_IDX | VERSION_1)
[ INFO] config: 0x40006000
[ INFO] found a block device of size 4194304KB
[ INFO] New an Ext4 Block Device
[DEBUG] OPEN Ext4 block device p_user=0x820d0c00
[kernel] Panicked at src/hal/trap/mod.rs:425 a trap Interrupt(Timer) from kernel!
```

ä¸€èˆ¬æ¥è¯´ï¼Œå½“åœ¨ç”¨æˆ·æ€å‘ç”Ÿå¼‚å¸¸/ä¸­æ–­æ—¶ï¼Œåº”è¯¥è¿›å…¥ `__alltraps`ï¼Œç„¶åè°ƒç”¨ç”¨æˆ·æ€å¤„ç†å‡½æ•° `trap_handler`ï¼Œå½“åœ¨å†…æ ¸æ€å‘ç”Ÿå¼‚å¸¸/ä¸­æ–­æ—¶ï¼Œåº”è¯¥è¿›å…¥å†…æ ¸æ€å¤„ç†å‡½æ•° `trap_handler_kernel`.

ä¿®æ”¹ä¸ºäº†æ­£ç¡®çš„å¤„ç†å‡½æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥ `panic!()`.

ä¸ºäº†å…¼å®¹æ€§è€ƒè™‘å°†ä¸¤ä¸ªæ¶æ„çš„ `KernelStack` ç»Ÿä¸€. ç„¶åé‡åˆ°äº†ç–‘ä¼¼æ—¶é—´ç‰‡çš„é—®é¢˜ï¼Œä¼šå¡ä½ç„¶åæ— æ³•è¿è¡Œ. polyha` ä¸Šå¯¹å†…æ ¸çš„ `Interrupt::Timer` å°±åšäº†ä¸€ä¸ªç®€å•çš„ `ticlr::clear_timer_interrupt()`. æˆ‘ä¹Ÿæ˜¯å¦‚æ­¤åšçš„ï¼Œä½†çœ‹èµ·æ¥å°±æ˜¯æœ‰ç‚¹é—®é¢˜.

GDB æ˜¾ç¤ºé”™è¯¯åœ¨

```rust
â”‚Spin> (self=0x820ac158 <os::hal::utils::console::CONSOLE::h2f3922a2e577e6f2>) at vendor/spin/src/mutex/spin.rs:185                                                               
â”‚185                 while self.is_locked() {
```

äº‹å®ä¸Š `c` ä¹‹ååˆ‡åˆ°æ–­ç‚¹å¤„å°±ä¼šå¡æ­».

è¿™ä¸ªé—®é¢˜å¾ˆè¯¡å¼‚ï¼Œæœ‰æ—¶å€™è¿˜ä¼šæŠ¥é”™

```shell
Interrupt enable: LineBasedInterrupt(HWI0 | TIMER)
/**** APPS ****
[ INFO] mmconfig_base = 0x20000000
[DEBUG] Enumerating PCI devices...
[DEBUG] alloc_pci: size = 0x1000
[DEBUG] alloc_pci: size = 0x4000
[DEBUG] Device features: BlkFeature(SEG_MAX | GEOMETRY | BLK_SIZE | FLUSH | TOPOLOGY | CONFIG_WCE | DISCARD | WRITE_ZEROES | RING_INDIRECT_DESC | RING_EVENT_IDX | VERSION_1)
[ INFO] config: 0x40006000
[ INFO] found a block device of size 4194304KB
[ INFO] New an Ext4 Block Device
[DEBUG] OPEN Ext4 block device p_user=0x820d3c00
[ERROR] ext4_recover: rc = 2
[kernel] Panicked at /home/lc/osrepo/os/libs/lwext4_rsut/src/blockdev.rs:110 Failed to mount the ext4 file system, perhaps the disk is not an EXT4 file system.: 2
```

å¦‚ä¸‹è¿™ç§æƒ…å†µä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ï¼š

```shell
Interrupt enable: LineBasedInterrupt(HWI0 | TIMER)
/**** APPS ****
[ INFO] mmconfig_base = 0x20000000
[DEBUG] Enumerating PCI devices...
[DEBUG] alloc_pci: size = 0x1000
[DEBUG] alloc_pci: size = 0x4000
[DEBUG] Device features: BlkFeature(SEG_MAX | GEOMETRY | BLK_SIZE | FLUSH | TOPOLOGY | CONFIG_WCE | DISCARD | WRITE_ZEROES | RING_INDIRECT_DESC | RING_EVENT_IDX | VERSION_1)
[ INFO] config: 0x40006000
[ INFO] found a block device of size 4194304KB
[ INFO] New an Ext4 Block Device
[DEBUG] OPEN Ext4 block device p_user=0x820d3c00
[kernel] Panicked at src/hal/trap/mod.rs:478 [pc:0x82033010], cause:Exception(MemoryAccessAddressError),  code:100000000000
```

æŸ¥é˜…ï¼Œ

> MemoryAccessAddressError = 8
>
> This exception is triggered when the virtual address of a load or store operation is illegal.

åœ¨ä¿®æ”¹äº† `__tlb_refill` åå§‹ç»ˆæŠ¥é”™

```shell
/**** APPS ****
[ INFO] mmconfig_base = 0x20000000
[DEBUG] Enumerating PCI devices...
[DEBUG] alloc_pci: size = 0x1000
[DEBUG] alloc_pci: size = 0x4000
[DEBUG] Device features: BlkFeature(SEG_MAX | GEOMETRY | BLK_SIZE | FLUSH | TOPOLOGY | CONFIG_WCE | DISCARD | WRITE_ZEROES | RING_INDIRECT_DESC | RING_EVENT_IDX | VERSION_1)
[ INFO] config: 0x40006000
[ INFO] found a block device of size 4194304KB
[ INFO] New an Ext4 Block Device
[DEBUG] OPEN Ext4 block device p_user=0x820d3c00
[kernel] Panicked at src/hal/trap/mod.rs:478 [pc:0x82033010], cause:Exception(MemoryAccessAddressError),  code:100000000000
```

GDB åœ¨ `[DEBUG] OPEN Ext4 block device p_user=0x820d3c00` æ‰“æ–­ç‚¹ï¼Œåœ¨åˆ°è¾¾è¿™ä¸€è¯­å¥ä¹‹å‰ä¼šè§¦å‘æ­»é”.

å®Œå…¨æ²¡å¤´ç»ª.

å°† `Periodic` è®¾ç½®ä¸º 0 å°±ä¼šè¿›å…¥

```shell
create_init_files success!                                                                     
[DEBUG] kernel: TaskManager::fetch_task                                                         
[ INFO] idle task cx ptr: 0x840d32d8, next task cx ptr: 0x840d2f48                             
[kernel] Panicked at src/hal/trap/mod.rs:477 [pc:0x82033090], cause:Exception(MemoryAccessAddressError),  code:0
```

 `tcfg::set_periodic(false)` ç„¶åä¹Ÿä¸æŠ¥æ­»é”é”™è¯¯äº†ï¼Œåº”è¯¥æ˜¯å› ä¸ºå½“è¿™ä¸ªå®šæ—¶å™¨å¾ªç¯æ¨¡å¼æ§åˆ¶ä½ `Periodic` è¢«è®¾ç½®ä¸º 1 æ—¶å°±ä¼šåœ¨è®¡æ—¶å™¨æ—¶é—´ç»“æŸåé‡æ–°è®¾ç½® `InitVal` åŸŸä¸­çš„å€¼è¿›è¡Œæ–°ä¸€è½®å¾ªç¯ï¼Œè¿™ä¸ªæ—¶å€™ `CONSOLE` é”æŒæœ‰çš„æœŸé—´å°±è§¦å‘äº†æ—¶é’Ÿä¸­æ–­ï¼Œåœ¨å¤„ç†ä¸­æ–­ä¸­åˆå†æ¬¡å°è¯•è·å– `CONSOLE.lock()`.

æ­»é”é—®é¢˜å§‘ä¸”å¤„ç†äº†ï¼Œä½†æ˜¯è¿˜æ˜¯ `Exception(MemoryAccessAddressError)`.

```shell
(gdb) c
Continuing.
Breakpoint 2, os::task::processor::run tasks()at src/task/processor.rs:114
114 					__switch(idle task cx ptr,next task cx ptr);
(gdb) s
[Inferior 1 (process 1) exited normally]
```

æ„å‘³ç€ä¸Šä¸‹æ–‡æ— æ³•åˆ‡æ¢.

```assembly
000000008205a000 <__trap_from_kernel>:
    8205a000:	0400c023 	csrwr       	$sp, 0x30
    8205a004:	0400c003 	csrrd       	$sp, 0x30
    8205a008:	02fc0063 	addi.d      	$sp, $sp, -256(0xf00)
    8205a00c:	00450c63 	srli.d      	$sp, $sp, 0x3
    8205a010:	00410c63 	slli.d      	$sp, $sp, 0x3
    8205a014:	29c02061 	st.d        	$ra, $sp, 8(0x8)
    ...
    8205a08c:	0400180c 	csrrd       	$t0, 0x6
    8205a090:	29c8406c 	st.d        	$t0, $sp, 528(0x210) # Excepetion
```

ä¹Ÿå°±æ˜¯æŠ¥é”™åœ¨ `__trap_from_kernel` çš„

```assembly
# skip r3(sp)
.set n, 4
.rept 28
SAVE_GP %n
.set n, n+1
.endr

csrrd $t0, CSR_ERA
st.d $t0, $sp, 66*8 # Excepetion
```

è¿™ä¸ªé—®é¢˜å¾ˆæ€ª.

### 2025.8.2

`addi.d $sp, $sp, -256` çš„ä½œç”¨å°±åœ¨äºå¼€è¾Ÿä¸€æ®µæ ˆç©ºé—´ï¼Œç”¨äºå­˜ä¸‹å„å¯„å­˜å™¨çš„å€¼ï¼Œä½†å¦‚æœå°† `66*8` æ”¹ä¸º  `st.d $t0, $sp, 0` å°±ä¼š

```assembly
000000008205a000 <__trap_from_kernel>:
    8205a000:	0400c023 	csrwr       	$sp, 0x30
    8205a004:	0400c003 	csrrd       	$sp, 0x30
    8205a008:	02fc0063 	addi.d      	$sp, $sp, -256(0xf00)
    8205a00c:	00450c63 	srli.d      	$sp, $sp, 0x3
    8205a010:	00410c63 	slli.d      	$sp, $sp, 0x3
    8205a014:	29c02061 	st.d        	$ra, $sp, 8(0x8)
    8205a018:	29c04062 	st.d        	$tp, $sp, 16(0x10)
    8205a01c:	29c08064 	st.d        	$a0, $sp, 32(0x20) # Exception
```

é—®é¢˜åœ¨äºï¼Œå…ˆå‰ä¹Ÿæœ‰ `__trap_from_kernel` ä½†æ˜¯ä¸ä¼šå‘ç”Ÿé—®é¢˜. æ‰€ä»¥æ˜¯ä¼ å€¼ä¸å¯¹.

ä¸€èˆ¬æ¥è¯´æ˜¯

```shell
create_init_files success!
[32m[DEBUG] kernel: TaskManager::fetch_task[0m
[34m[ INFO] idle task cx ptr: 0x8029b180, next task cx ptr: 0x8229a948[0m
[93m[ WARN] idle_task_cx_ptr ra: 0x0, next_task_cx_ptr ra: 0x8023ee2a[0m
[93m[ WARN] idle_task_cx_ptr sp: 0x0, next_task_cx_ptr sp: 0xfffff000[0m
[32m[DEBUG] kernel: TaskManager::fetch_task[0m
[34m[ INFO] idle task cx ptr: 0x8029b180, next task cx ptr: 0x8229a948[0m
[93m[ WARN] idle_task_cx_ptr ra: 0x80235f26, next_task_cx_ptr ra: 0x8023e93c[0m
[93m[ WARN] idle_task_cx_ptr sp: 0x8029ad70, next_task_cx_ptr sp: 0xffffee50[0m
[32m[DEBUG] in tcb inner, get trap cx, trap cx ppn is : 533258[0m
[34m[ INFO] ##### syscall with id 64 #####[0m
```

è°ƒæ•´å

```assembly
000000008205b000 <__trap_from_kernel>:
    8205b000:	0400c023 	csrwr       	$sp, 0x30
    8205b004:	0400c003 	csrrd       	$sp, 0x30
    8205b008:	02fc0063 	addi.d      	$sp, $sp, -256(0xf00)
    8205b00c:	00450c63 	srli.d      	$sp, $sp, 0x3
    8205b010:	00410c63 	slli.d      	$sp, $sp, 0x3
    8205b014:	29c02061 	st.d        	$ra, $sp, 8(0x8)
    8205b018:	29c04062 	st.d        	$tp, $sp, 16(0x10)
    8205b01c:	29c08064 	st.d        	$a0, $sp, 32(0x20)
    ...
    8205b058:	29c26073 	st.d        	$t7, $sp, 152(0x98)
    8205b05c:	29c28074 	st.d        	$t8, $sp, 160(0xa0) # Exception
```

å¥‡è¯¡. çœ‹èµ·æ¥æ˜¯ `sp` æœ‰é—®é¢˜ï¼Œä½†æ˜¯çœ‹å€¼è¿˜æŒºæ­£ç¡®çš„.

ä¸€èˆ¬æ¥è¯´ `__switch` ä¹‹åä¼šè·³è½¬åˆ° `trap_return` æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ `jr $ra` çš„ä½œç”¨.

### 2025.8.3

åº”å½“å…ˆè¿›å» `trap_return`ï¼Œ

```shell
create_init_files success!
[32m[DEBUG] kernel: TaskManager::fetch_task[0m
[34m[ INFO] idle task cx ptr: 0x8029b120, next task cx ptr: 0x8229a948[0m
[93m[ WARN] idle_task_cx_ptr ra: 0x0, next_task_cx_ptr ra: 0x8023c388[0m
[93m[ WARN] idle_task_cx_ptr sp: 0x0, next_task_cx_ptr sp: 0xfffff000[0m
[93m[ WARN] (trap_return) in riscv64 trap return[0m
[32m[DEBUG] kernel: TaskManager::fetch_task[0m
[34m[ INFO] idle task cx ptr: 0x8029b120, next task cx ptr: 0x8229a948[0m
[93m[ WARN] idle_task_cx_ptr ra: 0x80233e6c, next_task_cx_ptr ra: 0x8023be9a[0m
[93m[ WARN] idle_task_cx_ptr sp: 0x8029ad70, next_task_cx_ptr sp: 0xffffee50[0m
[93m[ WARN] (trap_return) in riscv64 trap return[0m
[32m[DEBUG] in tcb inner, get trap cx, trap cx ppn is : 533258[0m
[34m[ INFO] ##### syscall with id 64 #####[0m
```

å¦‚æœè¿™æ ·ï¼Œå°±ä¸åº”è¯¥è¿›å…¥ `__trap_from_kernel`ï¼Œè€Œæ˜¯åº”è¯¥ç»ç”± `jr $ra` å›åˆ° `trap_return`. å¯èƒ½æ˜¯ `$sp` ä¸å¯¹.

å¦‚æœæˆ‘ç›´æ¥è®©ä»–ä»¥ `trap_from_kernel` ä¸ºå…¥å£ `jr` è¿‡å»ï¼Œå¯ä»¥æˆåŠŸè·³è½¬ï¼Œé¿å…äº†ä¿å­˜å¯„å­˜å™¨ä¸Šä¸‹æ–‡æ—¶çš„æŠ¥é”™ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæŠ¥é”™åœ¨

```assembly
0000000082053320 <trap_from_kernel>:
    82053320:	02fac063 	addi.d      	$sp, $sp, -336(0xeb0)
    82053324:	29c52061 	st.d        	$ra, $sp, 328(0x148) # Exception
```

è€Œä¸”æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰è§£å†³ç±»ä¼¼çš„ `st.d` å‘ç”Ÿçš„é—®é¢˜. ä½†å…¶å®å®ƒå°±ä¸è¯¥è¿›å…¥ `__trap_from_kernel`. è€Œåº”è¯¥æ˜¯ `jr $ra` åˆ° `trap_return`.

çœ‹èµ·æ¥æ˜¯ `ld.d  $sp, $a1, 8` å­˜åœ¨é—®é¢˜.

ä½†æ˜¯è¯è¯´å›æ¥ä»–ä¸ºä»€ä¹ˆæ²¡æœ‰è·³è½¬åˆ° `trap_return`ï¼Ÿæˆ‘çš„ç†è§£æ˜¯åœ¨ `ld.d  $sp, $a1, 8` ä¸€å¥è§¦å‘äº†å†…æ ¸æ€ä¸­æ–­ç„¶åè·³è½¬åˆ° `__trap_from_kernel` å»æ‰§è¡Œè€Œæ²¡æœ‰ `jr $ra`. ä½†æ˜¯æ±‡ç¼–ä»£ç çœ‹èµ·æ¥å®Œå…¨æ²¡é—®é¢˜.

ä¿®æ”¹äº†å†…æ ¸æ ˆçš„å®ç°ï¼Œå¯ä»¥è¿›å…¥ `trap_return` äº†.

LoongArch ä¸‹ `$a0` å’Œ `$a1` åˆ†åˆ«å¯¹åº” `$r4` å’Œ `$r5`. é€šè¿‡ `info r` æŸ¥çœ‹å‘ç°æ­¤æ—¶å·²ç»é¡ºåˆ©æ‰§è¡Œäº† `__restore`ï¼Œ`$sp($r3)` æ˜¯ `trap_cx_user_va` äº†.

`TRAMPOLINE` å’Œ `strampoline` çš„åŒºåˆ«åœ¨äºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€. ä¼¼ä¹æ˜¯ `eentry` çš„å†…å®¹ä¸åŒäº `stvec` è¿˜æœ‰ä¸€ä¸ª `Mode::Direct` å‚æ•°. å®é™…ä¸Š `strampoline` çš„ä½ç½®å°±æ˜¯ `__alltraps` çš„ä½ç½®.

```assembly
0000000082001000 <__alltraps>:
    82001000:	0400c023 	csrwr       	$sp, 0x30
    82001004:	29c02061 	st.d        	$ra, $sp, 8(0x8)
    82001008:	29c04062 	st.d        	$tp, $sp, 16(0x10)
    8200100c:	29c08064 	st.d        	$a0, $sp, 32(0x20)
    ...
    8200107c:	2bc40060 	fst.d       	$fa0, $sp, 256(0x100) # badv
```

> 2025.8.15ï¼šæ„æ€æ˜¯ NPUCore æ˜¯ç›´æ¥ä»¥ strampoline è¿™ä¸ªç‰©ç†åœ°å€æ¥è®¡ç®— restore çš„åœ°å€ï¼Œå¦‚æœæ˜¯åœ¨ RISCV ä¸­åº”å½“ä»¥ TRAMPOLINE è™šæ‹Ÿåœ°å€æ¥è®¡ç®—.

éœ€è¦è®¾ç½® `euen` çš„ `fpe` ä½å¼€å¯æµ®ç‚¹æŒ‡ä»¤ä½¿èƒ½.

ç„¶åæŠ¥é”™ `Exception(InstructionNotExist)`.

```assembly
[93m[ WARN] (trap_return) in loongarch64 trap return[0m
[32m[DEBUG] in tcb inner, get trap cx, trap cx ppn is : 540969[0m
[32m[DEBUG] [kernel] trap_return: ..before return, restore_va = 0x82001170, trap_cx_ptr = 0x84129000, user_satp = 0x8410d[0m
[93m[ WARN] (trap_handler) in loongarch64 trap handler[0m
[34m[ INFO] badv: 0x10000[0m
[34m[ INFO] [kernel] trap_handler: Exception(InstructionNotExist) at 0x10000 as virtadd[0m
[34m[ INFO] [kernel] trap_handler: Exception(InstructionNotExist) at 0x10 as vpn[0m
```

è¿™ä¸ªåœ°å€å³æ˜¯ `user` é‡Œ `BASE_ADDRESS` çš„åœ°å€.

ç›¸å½“äºè¿›ç”¨æˆ·æ€ä¹‹åè®¿é—® `0x10000` è§¦å‘äº† `Excepetion(InstructionNotExist)`. å¦‚æœç”¨ GDB è¿½è¸ªé‚£ç›´æ¥å°±æ­»å¾ªç¯ï¼Œä¹ŸæŸ¥ä¸åˆ°å“ªé‡Œæœ‰é—®é¢˜ï¼Œå› ä¸º `$pc` éƒ½ä¸çŸ¥é“é£åˆ°å“ªé‡Œå»äº†.

å°† `crmd` çš„ `pg` å¼€å¯åé”™è¯¯å˜ä¸º `Exception(FetchPageFault)`.

æŠ¥é”™æ—¶è¯» `pgdl` å¾—åˆ° `pa` æ˜¯ `0x84129000`ï¼Œè€Œå†…æ ¸é¡µè¡¨ `activate` `ppn` æ—¶æ˜¯ `0x840d4`.

### 2025.8.4

`pgdl` é¦–å…ˆæ˜¯ `0x840d5`ï¼Œä¹Ÿå°±æ˜¯ `ekernel` çš„ `ppn`. åœ¨åˆ‡æ¢ä¸Šä¸‹æ–‡æ—¶åˆ‡æ¢ `pgdl` å˜ä¸º `0x8410e`ï¼Œç„¶åä¼šå˜æˆ `0x8412a`.

NPUCore è®©å†…æ ¸é¡µè¡¨ä¿å­˜åœ¨ `pgdh` ä¸­ï¼Œæœ‰ç‚¹ä¸ç†è§£. åº”è¯¥åªæ˜¯ä¸ºäº†ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ `makedev!` macro.

`__restore` ä¼šå°† `user_pgd` ä½œä¸º `$a1` ç„¶åç§»å…¥ `pgdl`ï¼Œä½†æ˜¯æ²¡æœ‰è¾¾åˆ°é¢„æœŸ. `jr $ra` çš„åœ°å€æ˜¯ `__restore` æ²¡é”™.

```shell
[93m[ WARN] (trap_return) in loongarch64 trap return[0m
[32m[DEBUG] in tcb inner, get trap cx, trap cx ppn is : 540969[0m
[93m[ WARN] era: 0x0, prmd: 0x7, crmd: 0x1c[0m
[32m[DEBUG] [kernel] trap_return: ..before return, restore_va = 0x82001170, trap_cx_ptr = 0x84129000, user_satp = 0x8410d[0m
[93m[ WARN] (trap_handler) in loongarch64 trap handler[0m
[93m[ WARN] pgdl: 0x84129000000, pgdh: 0x0, pgd: 0x84129000000[0m
[34m[ INFO] badv: 0x10000[0m
[34m[ INFO] [kernel] trap_handler: Exception(FetchPageFault) at 0x10000 as virtadd[0m
[34m[ INFO] [kernel] trap_handler: Exception(FetchPageFault) at 0x10 as vpn[0m
```

`trap_cx_ptr` çš„å€¼åœ¨åç§» 12 ä½åå­˜å…¥ `pgdl`ï¼Œè€Œä¸æ˜¯ `user_satp`.

è¿™ LoongArch çš„ `asm!` å®æœ‰é—®é¢˜å§ï¼Œæˆ‘åªæ˜¯æ¢äº†ä¸€ä¸ªå†™æ³•ç„¶åå°±èƒ½æ­£ç¡®è®¾ç½® `pgdl` äº†.

`0x10000` æ˜¯æˆ‘ä»¬åœ¨ `map_elf` è®¾ç½®çš„ç¬¬ä¸€é¡µè™šæ‹Ÿåœ°å€ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ ELF æ®µçš„èµ·å§‹åœ°å€ï¼Œæ— è®ºæ˜¯ç‰©ç†é¡µå¸§å·è¿˜æ˜¯æƒé™éƒ½çœ‹èµ·æ¥æ²¡ä»€ä¹ˆé—®é¢˜.

éš¾ä»¥ç†è§£. æ ¹æ® [RISC-V å†…å­˜è™šæ‹ŸåŒ–ç®€æï¼ˆäºŒï¼‰](https://tinylab.org/riscv-kvm-mem-virt-2/) å’Œ [riscv-virtual-memory | Francis's blog](https://www.francisz.cn/2020/07/15/riscv-virtual-memory/) çš„è¯´æ³•ï¼Œ`FetchPageFault` åœ¨äºæ‰§è¡Œæƒé™ä¸å¤Ÿ. å¯¹åº” `X` ä½. ä½†æ˜¯æƒé™è¢«æ­£ç¡®è®¾ç½®äº†.

å¯¹ç”¨æˆ·æ€çš„åŸºåœ°å€ `BASE_ADDRESS` æŠ¥é”™ï¼Ÿé—®é¢˜å‡ºåœ¨ç”¨æˆ·æ€å—ï¼Ÿ

å‘ç°ä¸€ä¸ªé—®é¢˜

```shell
[32m[DEBUG] [kernel] trap_return: ..before return, restore_va = 0x82001170, trap_cx_ptr = 0x8412a000, user_satp = 0x8410e[0m
[93m[ WARN] (trap_handler) in loongarch64 trap handler[0m
[93m[ WARN] pgdl: 0x8410e000, pgdh: 0x0, pgd: 0x8410e000[0m
[34m[ INFO] badv: 0x10000[0m
[34m[ INFO] [kernel] trap_handler: Exception(FetchPageFault) at 0x10000 as virtadd[0m
[34m[ INFO] [kernel] trap_handler: Exception(FetchPageFault) at 0x10 as vpn[0m
[93m[ WARN] (PageTableEntry, flags) bits: 0x8410f29d[0m
[kernel] Panicked at src/mm/page_table.rs:132 called `Option::unwrap()` on a `None` value
```

è¿™ä¸ªç‰©ç†åœ°å€æ‰€åœ¨çš„ç‰©ç†é¡µå¸§å·å³æ˜¯ `map_elf` æ—¶ç¬¬ä¸€é¡µè™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„ç‰©ç†é¡µå¸§.

### 2025.8.5

`find_pte_create` æ—¶å‡ºç°é”™è¯¯

```shell
[DEBUG] (MapArea, map_one, before pt.map): vpn: VPN:0x82000, ppn: PPN:0x82000, flags: R | X
[ WARN] PageTable::find_pte_create: vpn: VPN:0x82000, ppn: PPN:0x840d6, idx: 2
...
[ INFO] PageTableEntry::new: ppn: PPN:0x82000, flags: V | MAT_CC | P
[DEBUG] (MapArea, map) mapping vpn: VPN:0x82001
[DEBUG] (MapArea, map_one, before pt.map): vpn: VPN:0x82001, ppn: PPN:0x82001, flags: R | X
[ WARN] PageTable::find_pte_create: vpn: VPN:0x82001, ppn: PPN:0x840d6, idx: 2
[ INFO] PageTable::find_pte_create: pte: 0x840d9001, i: 0
[ INFO] [kernel] PageTableEntry::flags: bits: 0x840d9001
[kernel] Panicked at src/mm/page_table.rs:111 called `Option::unwrap()` on a `None` value
```

åŸå› æ˜¯ `flags()` æ—¶æ²¡æœ‰é€šè¿‡æ­£ç¡®çš„æ©ç è¿›è¡Œè¿ç®—. å¯¼è‡´ PTE çš„ ppn æš´éœ²å‡ºæ¥äº†.

ç„¶åé‡æ„äº† `find_pte_create` çš„é€»è¾‘ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡ä¿®æ­£ `FetchPageFault`.

æ ¹æ® [MIT6.S081 ---- Preparation: Read chapter 4](https://www.cnblogs.com/seaupnice/p/15809701.html)ï¼Œå‡ºç°è¿™ä¸ªçš„åŸå› æ˜¯ `$pc` æŒ‡å‘çš„è™šæ‹Ÿåœ°å€æ— æ³•è½¬æ¢.

åœ¨ `boot.rs` ä¸­

```assembly
sub.d       $t0,    $t0,    $t0
addi.d      $t0,    $t0,    0x11
csrwr       $t0,    0x180 		# DWM0
```

è¿™ä¼šå°†æ‰€æœ‰ä½åœ°å€è¿›è¡Œç›´æ¥æ˜ å°„ï¼Œç„¶åå°±å¯¼è‡´äº†æ˜ å°„é”™è¯¯ï¼Ÿå­˜ç–‘

æˆ‘ç–‘æƒ‘ä¸ºä»€ä¹ˆ NPUCore å¯ä»¥æ­£å¸¸è¿è¡Œ.

```rust
let (memory_set, heap_bottom, entry_point, _) = MemorySet::from_elf(elf_data, heap_id);
info!("kernel: create process from elf data, size = {}, ustack_base = {:#x}, entry_point = 		{:#x}",elf_data.len(), heap_bottom, entry_point);
// memory_set.activate();
let entry_point = memory_set.get_ref()
	.translate(entry_point.into())
	.unwrap()
	.ppn().0 << 12;
```

æ— æ³•ç¿»è¯‘. æ²¡èƒ½è§£å†³é—®é¢˜.

### 2025.8.6

NPUCore æœ‰ç‚¹éš¾ä»¥æŠŠæ¡ï¼Œæˆ‘è€ƒè™‘ç‰ºç‰²ä¸€äº›å…¼å®¹æ€§è€Œç”¨ [rCoreloongArch](https://github.com/Godones/rCoreloongArch) ä¸ºåŸºç¡€æ¥å®ç°ï¼Œæ—¶é—´æœ‰ç‚¹ç´§å¼ .

æˆ‘æ¯”è¾ƒå€¾å‘äºæ˜¯å› ä¸ºåœ°å€çª—å£æ˜ å°„çš„æœºåˆ¶å¯¼è‡´äº†åœ¨ä½ä½åœ°å€çš„æ’ç­‰æ˜ å°„ï¼Œå°±ä¼šå¯¼è‡´åœ¨ç¡¬ä»¶åº•å±‚è¯¸å¦‚ `0x10000` è¿™æ ·çš„åœ°å€ä¸å—æˆ‘ä»¬æ§åˆ¶é‡‡ç”¨åˆ†é¡µæ¨¡å¼è¿›è¡Œç¿»è¯‘.

å¦‚æœä»…ä»…æ˜¯æŠŠ loongArch æ”¾åœ¨é«˜ä½åœ°å€éƒ½è¿˜å¥½è¯´ï¼Œä¸»è¦è¿˜æ˜¯ Trap æ¯”è¾ƒéš¾æ”¹ï¼ŒrCoreloongArch å¹¶æ²¡æœ‰ä¿å­˜ `kernel_satp` è¿™äº›å‚æ•°ï¼Œæˆ‘æ‰“ç®—å†™ä¸€ä¸ªé€šç”¨æ¥å£ï¼Œå°½å¯èƒ½é™ä½ä¸Šå±‚ API çš„å·®å¼‚.

```shell
create_init_files success!
[32m[DEBUG] kernel: TaskManager::fetch_task[0m
[34m[ INFO] idle task cx ptr: 0x90000000002d30d0, next task cx ptr: 0x90000000022d2858[0m
[93m[ WARN] idle_task_cx_ptr ra: 0x0, next_task_cx_ptr ra: 0x900000000022eb00[0m
[93m[ WARN] idle_task_cx_ptr sp: 0x0, next_task_cx_ptr sp: 0x70000000022c8000[0m
[93m[ WARN] tlbrsave: 0x0, sp: 0x90000000002d2d50[0m
```

å¾ˆå¥‡æ€ªçš„ 7 å¼€å¤´ `$sp`. å› ä¸ºå‡äº†ä¸¤æ¬¡åç§»é‡å¯¼è‡´çš„æº¢å‡º.

ç„¶ååˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¡åœ¨ `__alltraps`. `$r3` å³ `$sp` ä¸ºæ¥è¿‘ `0x0` çš„ä¸€ä¸ªæ•°.

è¿›å…¥ `__restore` ååšäº†ä¸€äº›ç–‘ä¼¼ä¿ç•™ä¸Šä¸‹æ–‡çš„æ“ä½œ

```assembly
900000000021e418:	1a000ee8 	pcalau12i   	$a4, 119(0x77)
900000000021e41c:	02e5c108 	addi.d      	$a4, $a4, -1680(0x970)
900000000021e420:	29c2c068 	st.d        	$a4, $sp, 176(0xb0)
900000000021e424:	03800408 	ori         	$a4, $zero, 0x1
900000000021e428:	29c2e068 	st.d        	$a4, $sp, 184(0xb8)
900000000021e42c:	02c08069 	addi.d      	$a5, $sp, 32(0x20)
900000000021e430:	29c30069 	st.d        	$a5, $sp, 192(0xc0)
900000000021e434:	29c32068 	st.d        	$a4, $sp, 200(0xc8)
900000000021e438:	02c50069 	addi.d      	$a5, $sp, 320(0x140)
900000000021e43c:	29c34069 	st.d        	$a5, $sp, 208(0xd0)
900000000021e440:	29c36068 	st.d        	$a4, $sp, 216(0xd8)  	# stop
```

æˆ‘ä¸çŸ¥é“ç¼–è¯‘å™¨åº•å±‚ä¼˜åŒ–æˆä»€ä¹ˆæ ·äº†ï¼Œä½†æ˜¯åœ¨å¡æ­»ä¹‹å‰ï¼Œ`$sp` æ²¡æœ‰è¢«æ”¹å†™ï¼Œåå€’æ˜¯ `$a0` è¢«èµ‹äºˆä¸€ä¸ª `0x1b4` è¿™ç§è«åå…¶å¦™çš„å€¼ï¼Œè€Œä¸”æœ¬æ¥è¯´ `move $a0, {trap_cx_ptr}` ä¹Ÿæ²¡æœ‰åœ¨æ‰§è¡Œåèµ‹äºˆä¸€ä¸ªæ­£ç¡®çš„ `trap_cx_ptr` å€¼.

æ‰§è¡Œ `move $a0, {trap_cx_ptr}` ä¹‹å `$a0` ä¸æ˜¯ `0x90000000022c7dc8` è€Œæ˜¯ `0x900000000295000`. ä½†æ˜¯æ—¥å¿—é‡Œå°±å†™ç€

```shell
[93m[ WARN] tlbrsave: 0x0, sp: 0x90000000022c7e00, trap_cx_ptr(a0): 0x90000000022c7dc8, cx.sp: 0x4f450000[0m
```

è€Œ

```rust
warn!("tlbrsave: {:#x}, sp: {:#x}, trap_cx_ptr(a0): {:#x}, cx.sp: {:#x}", tlbrsave, sp, trap_cx_ptr, current_trap_cx().gp.x[3]);
unsafe {
    asm!(
        "move $a0, {trap_cx_ptr}",
        trap_cx_ptr = in(reg) trap_cx_ptr,
    );
    warn!("breakpoint");
    __restore();
}
```

é¾™èŠ¯çš„å·¥å…·é“¾å¾ˆä¸ç¨³å®š. æˆ‘ä¸çŸ¥é“æ€ä¹ˆæ‰èƒ½è®©ä»–è·‘èµ·æ¥. ä¸è¿‡ `$sp` æ˜¯æ­£ç¡®çš„.

å¦‚æœæˆ‘æ‰§è¡Œäº† `asm!` æ€ä¹ˆè¯´ä¹Ÿåº”è¯¥æ‰§è¡Œ `move` å§ï¼Ÿ

### 2025.8.7

åº”è¯¥æ˜¯åœ¨åº•å±‚é‡åˆ°äº†æ­»é”çš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆè§£å†³

<img src="../img/87.png" alt="87" style="zoom:80%;" />

æœ‰ç‚¹å¤ªè¿‡åº•å±‚äº†ï¼ŒGDB è°ƒè¯•æ˜¾ç¤ºåœ¨ä½¿ç”¨ LOG è¾“å‡ºæ—¶ä¼šæœ‰æ— æ³•è¾“å‡ºçš„æƒ…å†µï¼Œåº”è¯¥å°±æ˜¯é‡åˆ°äº†æ­»é”. ä½†æ˜¯å¦‚æœæˆ‘ä»…ä»…æ˜¯æŠŠæ—¥å¿—æ‰“å°ä¸‹æ¥ï¼Œå°±å¯ä»¥æ­£å¸¸æ˜¾ç¤º.

<img src="../img/872.png" alt="872" style="zoom:80%;" />

å…«æœˆäº”æ—¥æ— æ³•è§£å†³çš„é—®é¢˜ä¹ŸåŒæ ·å¡åœ¨è¿™é‡Œ.

åæ±‡ç¼–å¯¹åº”å‡ºæ¥æ˜¯

```assembly
0000000082001170 <__restore>:
    82001170:	004130a5 	slli.d      	$a1, $a1, 0xc
    82001174:	04006425 	csrwr       	$a1, 0x19
    82001178:	06498003 	invtlb      	0x3, $zero, $zero
    8200117c:	00150083 	move        	$sp, $a0
    ...
    82001190:	0114d980 	movgr2cf    	$fcc0, $t0
    82001194:	0044858c 	srli.w      	$t0, $t0, 0x1
    82001198:	0114d981 	movgr2cf    	$fcc1, $t0
    8200119c:	0044858c 	srli.w      	$t0, $t0, 0x1
    820011a0:	0114d982 	movgr2cf    	$fcc2, $t0
    820011a4:	0044858c 	srli.w      	$t0, $t0, 0x1
    820011a8:	0114d983 	movgr2cf    	$fcc3, $t0
```

åº”è¯¥æ˜¯æ­»é”çš„é—®é¢˜.

æ‰€ä»¥æ˜¯å› ä¸ºä¸Šä¸‹æ–‡æ¢å¤ä¸å…¨ï¼Œæ‰€ä»¥å°±ä¼š `FetchPageFault` å—ï¼Ÿ

æ­»é”æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ `trap_return` é‡Œä½¿ç”¨ `LOG` å°±ä¼šè§¦å‘æ­»é”. åŸå› åº”è¯¥æ˜¯åœ¨é™·å…¥ Trap ä¹‹å‰ `CONSOLE` å·²ç»è¢«æŒæœ‰. å°†è¿™äº›è¾“å‡ºå–æ¶ˆå°±ä¼šè·³åˆ° `strampoline`ï¼Œä¹Ÿå°±æ˜¯ `__alltraps`. å®é™…ä¸Šè¿˜æ˜¯é‚£ä¸ªæ— æ³•è®¿é—®çš„é—®é¢˜ï¼Œå°±è§¦å‘ Exception.

ç„¶åç»§ç»­ä¿®å¤ä¹‹å‰çš„ `FetchPageFault`ï¼ŒGDB æ˜¾ç¤º `$sp` ä¸º `0x68cc315255ca74c4` æŸå. è€Œä¸”æ— æ³• `bt` å›æº¯å‡½æ•°è°ƒç”¨æ ˆ.

RV çš„ä¸Šä¸‹æ–‡çš„æ¢å¤å¥½åƒå’Œ LA ä¸ä¸€æ ·.

åœ¨æ¢å¤ä¸Šä¸‹æ–‡è¿‡ç¨‹ä¸­è§¦å‘äº† `StorePageFault`ï¼Œä½†æ˜¯æˆ‘æ‰§è¡Œçš„éƒ½æ˜¯ `ld` æŒ‡ä»¤ï¼Ÿ

<img src="../img/873.png" alt="873" style="zoom:80%;" />

<img src="../img/874.png" alt="874" style="zoom:80%;" />

debug ä¸€å¤©ï¼Œè¿˜æ˜¯é‡åˆ°å„ç§è«åå…¶å¦™çš„é”™è¯¯. NPUCore ä»–ä»¬åœ¨ `map_elf` æ—¶ä¼šåœ¨å†…æ ¸åœ°å€ç©ºé—´å¯»æ‰¾ä¸€ä¸ªä½ç½®ç„¶åæ’å…¥ï¼Œæœ€åä¼¼ä¹æ˜¯è¿™æ ·ç»•å¼€äº†åœ°å€æ˜ å°„çª—å£çš„ç›´æ¥æ˜ å°„ï¼Œè¿™æ ·åœ°å€ç¿»è¯‘å°±æ­£ç¡®äº†ï¼Œä½†æ˜¯ä»–ä»¬çš„é‚£ä¸ªè®¾è®¡æœ‰ç‚¹å¤æ‚. rCoreloongArch è¿™é‡Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆç°åœ¨æ‰§è¡Œèµ·æ¥ä¸€ç›´ä¼šé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œéƒ½å¾ˆå¥‡æ€ªï¼Œä¸è¿‡æˆ‘åœ¨å®é™…è°ƒè¯• rCoreloongArch çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šé‡åˆ°å¡æ­»çš„é—®é¢˜ï¼Œç‰¹åˆ«å¥‡æ€ª. æ€»è€Œè¨€ä¹‹ç»è¿‡äº†ä¸€å‘¨å¤šçš„æ—¶é—´ä¸Šä¸‹æ–‡å°±æ˜¯åˆ‡æ¢ä¸è¿‡å». æ‰€ä»¥è¯´ä¸ºäº†å…¼å®¹æ€§ç»“æœä»€ä¹ˆä¹Ÿæ²¡å®ç°.

### 2025.8.8

ä¹‹åé‡å¤æŠ¥é”™çš„ StorePageFault é€šè¿‡åæ±‡ç¼–å…¶å®æ˜¯

```assembly
900000000025a1c0 <shutdown>:
900000000025a1c0:	14201c04 	lu12i.w     	$a0, 65760(0x100e0)
900000000025a1c4:	03807084 	ori         	$a0, $a0, 0x1c
900000000025a1c8:	0380d005 	ori         	$a1, $zero, 0x34
900000000025a1cc:	29000085 	st.b        	$a1, $a0, 0 	# StorePageFault
```

ç°åœ¨æ˜¯è¿™æ ·çš„ï¼Œé—®é¢˜è¿˜æ˜¯è®¿é—®ç”¨æˆ·ç¨‹åº `BASE_ADDRESS` çš„åœ°å€ `0x10000` ä¼šå‡ºç° FetchPageFaultï¼Œç„¶ååœ¨ `shutdown` æ—¶ä¼šè§¦å‘ StorePageFault ç„¶åæ­»å¾ªç¯.

å¦‚æœæˆ‘æ˜¯ç”¨ GDB è°ƒè¯•å°±ä¼šåœ¨ `__restore()` é€”ä¸­æŠ¥é”™ StorePageFaultï¼Œé”™è¯¯åœ°å€æ˜¯ `0x4f450008`ï¼Œä¹‹å‰æœ‰ä¸€å¼ æ—¥å¿—æˆªå›¾ï¼Œæƒ…å†µæ˜¯å·®ä¸å¤šçš„ï¼Œä¸è¿‡é‚£ä¸ªå›¾çš„ `pgdl` å’Œ `pgd` æ²¡æœ‰æ­£ç¡®è¯»å–ï¼Œè¯»å–å¾—åˆ°æ˜¯ `0x22d4000`. é”™è¯¯å‘ç”Ÿ `ld` æŒ‡ä»¤. å› ä¸º GDB è°ƒè¯•è¿‡ç¨‹ä¸­ä¼šç”±äºç«äº‰çŠ¶æ€å’Œæ—¶é—´çš„ä¸åŒä¼šä¸ä¸€èˆ¬çš„æ—¥å¿—è¾“å‡ºå¾—åˆ°ä¸åŒçš„ç»“æœï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ—¥å¿—å¯èƒ½æ›´å¯é äº›ï¼Œä½†æ˜¯æ—¥å¿—æ— æ³•è·å–åº•å±‚çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯.

ç°åœ¨æ¥è¯´ï¼Œæˆ‘å‚è€ƒ rCoreloongArch çš„ç‰ˆæœ¬å’Œå‚è€ƒ NPUCore çš„ç‰ˆæœ¬é‡åˆ°äº†ç›¸åŒçš„ **FetchPageFault** é”™è¯¯.

>  A "fetch page fault" occurs when the CPU attempts to fetch an instruction from a virtual memory address that is not currently present in physical RAM. The operating system handles this by bringing the required page from secondary storage (like a hard drive or SSD) into physical memory. 

**åº”å½“ä¿è¯æ¯ä¸€æ¬¡æäº¤æ—¶ä»£ç éƒ½èƒ½è¿è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æµ…æ˜¾çš„é“ç†.**

å…ˆä¸è®ºä¸ºä»€ä¹ˆä¼šè§¦å‘ StorePageFaultï¼Œä½† `0x4f450008` ç¡®å®æ²¡è¢«æ˜ å°„.

```assembly
[32m[DEBUG] (MemorySetInner, push)[0m
[32m[DEBUG] (MapArea, map) mapping area[0m
[34m[ INFO] in alloc_user_res, ustack_bottom: 0x4f448000, ustack_top: 0x4f450000[0m
[93m[ WARN] in alloc_user_res, trap_cx_bottom: 0x50000000, trap_cx_top: 0x50001000[0m
```

æƒé™ä¸Šä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜

```assembly
[32m[DEBUG] elf program header count: 4[0m
[32m[DEBUG] (map_elf) start_va 0x10000 end_va 0x14cf4[0m
[93m[ WARN] (map_elf) pteflags: V | PLVL | PLVH | MAT_CC | P with 0x9d[0m
[32m[DEBUG] MapArea::new start floor = 0x10, end ceil = 0x15[0m
[32m[DEBUG] (map_elf) start_va 0x15000 end_va 0x15d18[0m
[93m[ WARN] (map_elf) pteflags: V | PLVL | PLVH | MAT_CC | P | NX with 0x400000000000009d[0m
[32m[DEBUG] (map_elf) start_va 0x16000 end_va 0x1e140[0m
[93m[ WARN] (map_elf) pteflags: V | D | PLVL | PLVH | MAT_CC | P | W | NX with 0x400000000000019f[0m
```

æœ€éš¾ä»¥ç†è§£çš„æ˜¯åœ¨é‡æ„å LoongArch ä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯ RISCV ä¸€åˆ‡æ­£å¸¸. è®¿é—® `0x10000` æ—¶çš„ `pgd` ä¹Ÿå’Œåˆ›å»ºåœ°å€æ˜ å°„æ—¶ä¸€æ ·.

### 2025.8.9

å¦‚æœä½¿ç”¨æ›´æ–°æˆ–è€…æ›´æ—§çš„ rustc ç‰ˆæœ¬è¿è¡Œç»“æœæ¯”ç°åœ¨è¿˜å·®. æˆ‘ä»¬å‚è€ƒçš„ rCoreloongArch å¦‚æœæ›´æ–°äº† rustc çš„ç‰ˆæœ¬ä¹Ÿä¼šå¡æ­».

ç”¨ AI ä¸€é€š debugï¼Œæ‰‹åŠ¨è¿›è¡Œ TLB åˆ·æ–°ï¼Œç»“æœè¿˜æ˜¯è§£å†³ä¸äº†é—®é¢˜.

ä½¿ç”¨ä¸Šå¤çš„ `372d41` commit é‡å¼€äº†ä¸€ä¸‹ï¼Œå‘ç°è¿˜ç®—å¯ä»¥ç”¨ï¼ŒåŸºäºä¿®æ”¹äº† `sys_execve` ä¹‹åå‘ç°å·®å¼‚ä¼¼ä¹ä¹Ÿæ²¡æœ‰æƒ³è±¡çš„é‚£ä¹ˆå¤§ï¼Œæˆ–è€…ä¸å¦‚è¯´æˆ‘è¿˜å¯ä»¥å‚è€ƒè¿™ä¸ªæ¯”è¾ƒå¤æ—©çš„ç‰ˆæœ¬ä¿®æ”¹. å› ä¸ºæˆ‘æ²¡åœ¨å…¶ä¸­å‘ç° FetchPageFault è€Œæ˜¯å¯¹ä¸€ä¸ªæé«˜åœ°å€çš„ StorePageFault. è¿™ä¸ªåº”è¯¥å°±æ˜¯ç”¨æˆ·çš„ `sp` æ²¡æœ‰æ­£ç¡®è®¾ç½®å¯¼è‡´çš„.

### 2025.8.10

æ—©ä¸Šç»§ç»­ä¿®æ”¹ï¼Œè§£å†³äº† `sys_exec` ä¸­ `pathp` ä¼  0 çš„é—®é¢˜ï¼Œå°±æ˜¯ä¸€äº›é¡µæ²¡æœ‰åˆ†é….

ç„¶ååˆé‡åˆ°äº† FetchPageFault çš„é—®é¢˜ï¼Œä¼¼ä¹æ˜¯å†…æ ¸æ ˆçš„é—®é¢˜ï¼Œåœ¨åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´åæ²¡æœ‰æ­£ç¡®ä¿æŒï¼Œè®© `sepc` å˜ä¸º 0 äº†.

å› ä¸ºä¹‹å‰è®¾è®¡ä¸¤ä¸ªæ¶æ„çš„æ—¶å€™å¯¹ Trap åšäº†ä¸åŒçš„å¤„ç†ï¼Œç°åœ¨æ ¹æœ¬ä¸æ•¢å¤§æ”¹. 

ä¸Šä¸‹æ–‡åˆ‡æ¢çš„éƒ¨åˆ†çœŸçš„å¾ˆéš¾æ”¹.

ç›´æ¥è¡¨ç°åœ¨ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹ä»è€Œè§¦å‘. åº”è¯¥æ˜¯**é¡µè¡¨æœ¬èº«æ‰€åœ¨çš„ç‰©ç†å†…å­˜æ²¡æœ‰è¢«æ­£ç¡®åœ°æ˜ å°„åˆ°å†…æ ¸çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚**

```rust
if alloc_ustack {
    (ustack_bottom, ustack_top) = process_inner.memory_set.insert_framed_area_with_hint(
        USER_STACK_TOP,
        USER_STACK_SIZE,
        MapPermission::default() | MapPermission::W,
        MapAreaType::Stack,
    );
}
```

åº•å±‚æ˜¯è¿™æ ·çš„

```rust
if pte.is_zero() {
    let frame = frame_alloc().unwrap();
    // é¡µç›®å½•é¡¹åªä¿å­˜åœ°å€
    *pte = PageTableEntry {
        bits: frame.ppn.0 << PAGE_SIZE_BITS,
    };
    self.frames.push(frame);
}
```

åœ¨ `*pte` ä¼šè§¦å‘ FetchPageFaultï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¿™é‡Œè¾“å‡ºæ—¥å¿—å°±ä¼šè§¦å‘ StorePageFault æˆ–è€… LoadPageFault.

åªæ˜¯ä¸€å¥æ—¥å¿—è¾“å‡ºç»“æœå°±ä¼šä¸ä¸€æ ·å—ï¼Ÿ

æ¢ä¸€ä¸ªç‰ˆæœ¬æ›´é«˜çš„ç¼–è¯‘å™¨ï¼Œå¡æ­»åœ¨è¾“å‡º FLAG ä¹‹å.

é˜Ÿå‹å°è¯•äº†ä¸€ä¸‹è¿™ä¸ªé¡µè¡¨æœç´¢çš„æœºåˆ¶ï¼Œå‘ç°ä»–æ€»æ˜¯*ç¥å¥‡åœ°*åœ¨æœ€åä¸¤é¡µæ— æ³•åˆ†é…ï¼Œä»–å°±è®¾è®¡äº†ä¸€ä¸ªæ–¹æ³•è·³è¿‡æœ€åçš„å‡ é¡µï¼Œæœä¸å…¶ç„¶çš„å¤±è´¥äº†.

å®é™…ä¸Šä» `frame_alloc` è¿”å› `Some(frame)` ç«Ÿç„¶æŠ¥é”™å¼€å§‹å°±åŸºæœ¬æ²¡å¸Œæœ›äº†ï¼Œç«Ÿç„¶åªæ˜¯åŠ äº†ä¸€å±‚ `Some` å°±ä¼šè§¦å‘ PageFault å—ï¼Ÿ

æç½® loongarch.

FetchPageFault çš„é”™è¯¯å°±åƒ NotReady ä¸€æ ·ï¼Œæ„Ÿè§‰æ˜¯æ•´ä¸ªå·¥å…·é“¾å’Œä¾èµ–çš„é—®é¢˜ï¼Œåªè¦è¿™ä¹ˆå†™å°±ä¼šæœ‰é—®é¢˜. ä»¤äººå¥½å¥‡å…¶ä»–é˜Ÿä¼çš„ loongarch æ˜¯æ€ä¹ˆè·‘èµ·æ¥çš„. å®é™…ä¸Šç¨å¾®å‡é«˜ rustc çš„ç‰ˆæœ¬ï¼ŒrCoreloongArch å°±ä¼šåœ¨åˆå§‹æ—¶å¡æ­»ï¼Œæˆ‘ä»¬çš„å†…æ ¸ä¹Ÿæ˜¯åœ¨è¾“å‡º `FLAG` ä¹‹åå°±ä¸èƒ½ç”¨äº†. 

### 2025.8.11

åˆå¹¶äº†åˆ†æ”¯.

å‘ç°ä¹‹å‰ 7.29 è§£å†³è¿‡ FetchPageFault çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹‹ååˆé‡åˆ°ä¸€ä¸ª FetchPageFault. è€Œä¸”é”™çš„æœ‰ç‚¹æ²¡é“ç†. æˆ‘å’Œé˜Ÿå‹æ¯”è¾ƒæ€€ç–‘æ˜¯åº•å±‚çš„é—®é¢˜.

å¦‚æœæ ¹æ®ä¸åŒçš„æ¶æ„ï¼Œå…¶ syscall id ä¹Ÿä¼šä¸åŒ. ä»è¿™ä¸ªè§’åº¦æ¥è¯´ StarryOS æ˜¯å¯¹çš„ï¼Œæˆ‘ä»¬å¤ªè‰ç‡.

å®ç°å†³èµ›æµ‹ä¾‹. 

[IRQ](https://www.kernel.org/doc/html/v5.16/translations/zh_CN/core-api/irq/concepts.html) æ˜¯ä¸€ä¸ªå…¨å±€ `irq_desc` æ•°ç»„çš„ç´¢å¼•. `p` æ˜¯ä¸€ä¸ªè¿½è¸ªå½“å‰å¤„ç†ä¸­æ–­å·ä½ç½®çš„ä¸€ä¸ª pointer.

1. **`if (irq < p)`** - æ£€æŸ¥ä¸­æ–­å·æ˜¯å¦é€’å‡
   - å¦‚æœå½“å‰è¯»åˆ°çš„ä¸­æ–­å·å°äºä¹‹å‰å¤„ç†åˆ°çš„ä½ç½®ï¼Œè¯´æ˜ä¸­æ–­å·ä¸æ˜¯å•è°ƒé€’å¢çš„
2. **`for (; p < irq; ++p)` + `if (vis[p])`** - æ£€æŸ¥ä¸­æ–­è®¡æ•°æ˜¯å¦"æ¶ˆå¤±"
   - æ£€æŸ¥ä»ä¸Šæ¬¡ä½ç½®åˆ°å½“å‰ä¸­æ–­å·ä¹‹é—´ï¼Œæ˜¯å¦æœ‰ä¹‹å‰å­˜åœ¨çš„ä¸­æ–­å·ç°åœ¨æ²¡æœ‰äº†
3. **`if (vis[irq] > cnt)`** - æ£€æŸ¥ä¸­æ–­è®¡æ•°æ˜¯å¦å‡å°‘
   - å¦‚æœæŸä¸ªä¸­æ–­å·çš„è®¡æ•°æ¯”ä¹‹å‰è®°å½•çš„å°ï¼Œè¯´æ˜è®¡æ•°å‡å°‘äº†ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰
4. **`vis[irq] = cnt`** - è®°å½•å½“å‰ä¸­æ–­å·çš„è®¡æ•°
   - `vis` æ•°ç»„ç”¨æ¥ä¿å­˜æ¯ä¸ªä¸­æ–­å·å†å²ä¸Šçš„æœ€å¤§è®¡æ•°å€¼

æœ‰ç‚¹å¥‡æ€ªï¼Œå®ƒåº”è¯¥å·²ç»æ²¡é”™äº†æ‰å¯¹.

### 2025.8.12

çœ‹èµ·æ¥å°±åƒä¸€æ¬¡å¯¹ interrupts çš„ `read()` è¯»å–äº†ä¸¤æ¬¡å…¶ä¸­çš„æ•°æ®ä¸€æ ·. è¿™ä¸ªæ²¡ä»€ä¹ˆè§£å†³æ€è·¯.

ä¿®äº†ä¸€ä¸ªå†…æ ¸ä¸ç”¨æˆ·æ€åœ°å€ç¿»è¯‘çš„é—®é¢˜.

å¯¹äº copy_from_file è¿™ä¸ªæµ‹ä¾‹ï¼Œä¸ºä»€ä¹ˆä¼šç”¨ LOG è¾“å‡ºå°±å¯ä»¥å…¨éƒ¨é€šè¿‡ä½†æ˜¯ä¸åŒç”¨ LOG å°±ä¸ä¼šé€šè¿‡å‘¢ï¼Œä¼¼ä¹æ˜¯ä¸€ä¸ªæ—¶åºé—®é¢˜. æ„Ÿè§‰å’Œ GDB è°ƒè¯•å°±ä¼šå‡ºç°ä¸åŒç»“æœä¸€æ ·ï¼Œåœ¨ç³»ç»Ÿç¼–ç¨‹é‡Œä¼¼ä¹è¿˜ç®—å¸¸è§. è¯´æ¥å‰å‡ å¤©é˜Ÿå‹åœ¨å®ç° net æ¨¡å—æ—¶ä¹Ÿé‡åˆ°äº†è¿™ä¸ªï¼Œæ˜¯è¯´åœ¨ exit çš„ç›¸å…³æ–¹æ³•é‡Œæå‰é‡Šæ”¾äº†è¿›ç¨‹çš„ pidï¼Œç°æœ‰çš„åˆ†æ”¯å·²ç»è§£å†³äº†è¿™ä¸ªé—®é¢˜æ‰å¯¹ï¼Œç°åœ¨åˆå‡ºç°äº†. è¿™ç§ bug ä¼¼ä¹è¢«ç§°ä¸º [Heisenbug](https://zh.wikipedia.org/wiki/æµ·æ£®å ¡bug).

é˜Ÿå‹å†™å¥½äº† net ç›¸å…³çš„æ¨¡å—ï¼Œæˆ‘æ¥å†™ä¸€ä¸‹ç½‘ç»œæ¨¡å—çš„é©±åŠ¨.

é˜Ÿå‹æ”¹å†³èµ›æµ‹ä¾‹çš„ bugï¼Œæˆ‘æ ¹æ®å‚è€ƒå†™ä¸€äº› syscalls. é‡åˆ°äº†å¾ˆå¤šå…³äº LoadPageFault å’Œ StorePageFault çš„é—®é¢˜ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æ²¡æœ‰å°†åœ°å€ç¿»è¯‘åˆ°ç”¨æˆ·æ€ï¼Œä¸è¿‡æˆ‘æ„Ÿåˆ°å¥‡æ€ªçš„æ˜¯ä¸ºä»€ä¹ˆå¢åŠ äº†ä¸€äº› net ç›¸å…³çš„ syscalls åè€Œä¼šå¯¼è‡´ä¹‹å‰ä¸ä¾èµ– net ç›¸å…³çš„æµ‹ä¾‹è§¦å‘ PageFault.

ä¸ºä»€ä¹ˆ StarryOS çš„å®ç°å¦‚æ­¤ç®€å•å‘¢ï¼Œç»„ä»¶åŒ–æ˜¯æœ‰å¥½å¤„çš„. ä½†æ˜¯ç»„ä»¶åŒ–ä¹Ÿè®©æˆ‘ä»¬æœ‰ç‚¹åˆ†ä¸æ¸…ç©¶ç«Ÿæ˜¯è°åœ¨è°ƒç”¨è°.

### 2025.8.13

ç»§ç»­å®ç°ä¸€äº› syscallsï¼Œ`sys_pread64` é‡åˆ°äº†å…ˆå‰é‡åˆ°çš„ NotReady é—®é¢˜.

å¯¹äºè¿™ä¸ªåº”è¯¥æ˜¯é©±åŠ¨åº•å±‚çš„é—®é¢˜æš‚æ—¶å…ˆä½¿ç”¨ç‰¹åˆ¤å¤„ç†ï¼Œç›´æ¥ `return`.

å°è¯•å¯åŠ¨ iozoneï¼Œä½†æ˜¯ musl ä¸‹çš„ iozone éœ€è¦ä¸€ä¸ª so é“¾æ¥ï¼Œè¿™ä¸ªé“¾æ¥åªæœ‰åœ¨ glibc è¿™ä¸ªç›®å½•ä¸‹æœ‰ï¼Œç›´æ¥é“¾æ¥ä¼šå‡ºç° LoadPageFault çš„é—®é¢˜

é˜Ÿå‹è¯´å»å¹´çš„ so ä¹Ÿå¯ä»¥ç”¨ï¼Œå¤åˆ¶è¿‡æ¥äº†. ç¾¤é‡Œè¯´è¿™ä¸ªåœ¨ç¼–è¯‘é•œåƒé‡Œï¼Œæ€ä¹ˆæ²¡æ‰¾åˆ°å‘¢.

### 2025.8.14

çœ‹äº†ä¸€ä¸‹æ˜¨å¤©é˜Ÿå‹æ˜¯å¦‚ä½•ä¿®å¤ glibc çš„ `sig_return` ç¬¦å·é—®é¢˜çš„ï¼Œè¯´æ¥å¾ˆå¥‡æ€ªï¼Œå°±æ˜¯åœ¨ä¿¡å·å¤„ç†æ—¶ `ra` è¿”å›è™šæ‹Ÿåœ°å€ï¼Œç„¶åå°†è¿™ä¸ªåœ°å€æ”¾åœ¨ç”¨æˆ·ç©ºé—´è€Œä¸æ˜¯å†…æ ¸ç©ºé—´é‡Œ. è‡³äºåˆ é™¤äº†é“¾æ¥è„šæœ¬çš„ç¬¦å·æˆ‘ä¸ªäººè®¤ä¸ºåº”è¯¥æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä¿®æ”¹ `.text` æ®µå¸ƒå±€æ²¡ä»€ä¹ˆå…³ç³».

å¢åŠ ç¯å¢ƒå˜é‡è§£å†³ glibc çš„ so.6 ç‰ˆæœ¬è¿‡ä½çš„é—®é¢˜.

å¦‚æœé‡‡ç”¨é˜Ÿå‹çš„ glibc ä¿®å¤å°±ä¼š

```sh
testcase busybox pwd success
              total        used        free      shared  buff/cache   available
Mem:   70368744177664     2086148 70368742044872           0       46644      873464
Swap:             0           0           0
testcase busybox free success
Sun Dec 31 00:00:00 1899  0.000000 seconds
testcase busybox hwclock success
[kernel] Panicked at src/mm/memory_set.rs:666 called `Result::unwrap()` on an `Err` value: "File is shorter than the first ELF header part"
```

éå¸¸è«åå…¶å¦™çš„é—®é¢˜. ä¸èƒ½ä¿®å¤å°±ç‰¹åˆ¤è·³è¿‡.